---
phase: 03-vapi-integration
plan: 04
type: execute
---

<objective>
Handle Vapi webhook events to log calls with transcripts, duration, and status.

Purpose: Track all calls to agents for history display and (later) credit deduction. This completes the call flow - users can now make calls and see them in their dashboard.
Output: Webhook endpoint for Vapi server URL events, call records saved to database, call history UI with transcripts.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-vapi-integration/03-RESEARCH.md
@.planning/phases/03-vapi-integration/03-03-SUMMARY.md

**From RESEARCH.md - Webhook patterns:**
- Webhook must respond within 7.5 seconds
- Key events: status-update, end-of-call-report, transcript
- end-of-call-report contains: call.id, artifact.transcript, endedReason, duration
- Do heavy processing asynchronously after responding

**From RESEARCH.md - Pitfalls to avoid:**
- Webhook response timeout (keep handlers fast <3s)
- Not storing Vapi IDs (always store vapiCallId)

**Database schema (existing):**
- Call model has: vapiCallId, status, startedAt, endedAt, durationSeconds, transcript, summary
- CallStatus enum: RINGING, IN_PROGRESS, COMPLETED, FAILED, NO_ANSWER

**Relevant source files:**
@prisma/schema.prisma
@src/app/api/calls/route.ts
@src/app/(dashboard)/dashboard/calls/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Vapi webhook endpoint with event routing</name>
  <files>src/app/api/webhooks/vapi/route.ts</files>
  <action>
    1. Create POST /api/webhooks/vapi endpoint:
       - Parse JSON body, extract message object
       - Log event type for debugging: console.log(`Vapi webhook: ${message.type}`)
       - Route based on message.type:
         - "status-update": Handle call status changes
         - "end-of-call-report": Save completed call data
         - Other events: Log and acknowledge
       - Always respond quickly with { received: true }

    2. Handle "status-update" events:
       - Extract: call.id, call.assistantId, status
       - Find agent by vapiAssistantId
       - If status is "ringing" or "in-progress":
         - Upsert Call record (create if not exists, update if exists)
         - Set status to RINGING or IN_PROGRESS
         - Set startedAt to call.startedAt or now()
       - If status is "ended":
         - Wait for end-of-call-report for full details

    3. Handle "end-of-call-report" events:
       - Extract: call.id, call.assistantId, artifact.transcript, endedReason
       - Calculate duration from call.startedAt and call.endedAt
       - Map endedReason to CallStatus:
         - "assistant-ended" or "user-ended" → COMPLETED
         - "assistant-error" → FAILED
         - "no-answer" → NO_ANSWER
         - Other → COMPLETED (default)
       - Update Call record:
         - status, endedAt, durationSeconds, transcript
         - creditsUsed: 0 for now (Phase 5 handles credit deduction)

    4. Important: Keep handler fast (<3s response time)
       - Do NOT do expensive operations before responding
       - Respond first, then process asynchronously if needed
  </action>
  <verify>npm run build succeeds, endpoint compiles without TypeScript errors</verify>
  <done>Webhook endpoint handles status-update and end-of-call-report events</done>
</task>

<task type="auto">
  <name>Task 2: Create call record management and lookup helpers</name>
  <files>src/lib/calls.ts, src/app/api/webhooks/vapi/route.ts</files>
  <action>
    1. Create src/lib/calls.ts with helper functions:
       - findAgentByVapiAssistantId(assistantId: string): Look up agent and user
       - upsertCallFromWebhook(data: WebhookCallData): Create or update call record
       - Type definitions for webhook payloads (WebhookStatusUpdate, WebhookEndOfCall)

    2. upsertCallFromWebhook implementation:
       - If vapiCallId exists in DB: update existing record
       - If not exists: create new record
       - Always include: agentId, userId (from agent), vapiCallId
       - Handle missing agent gracefully (log warning, skip)

    3. Update webhook route to use helpers:
       - Use findAgentByVapiAssistantId to resolve agent/user
       - Use upsertCallFromWebhook for all call operations
       - Clean separation of concerns

    4. Add phone number to call record:
       - Extract caller phone from webhook (call.customer.number or similar)
       - Store in Call.phoneNumber field
  </action>
  <verify>npm run build succeeds, helpers properly typed</verify>
  <done>Call record helpers created, webhook uses clean abstractions</done>
</task>

<task type="auto">
  <name>Task 3: Update call history UI to show transcript and call details</name>
  <files>src/app/(dashboard)/dashboard/calls/page.tsx, src/app/(dashboard)/dashboard/calls/[id]/page.tsx, src/app/api/calls/[id]/route.ts</files>
  <action>
    1. Create GET /api/calls/[id] endpoint:
       - Require authentication
       - Fetch call by ID with ownership check (call.userId matches user)
       - Include agent info in response
       - Return full call details including transcript

    2. Create call detail page at /dashboard/calls/[id]:
       - Display: Agent name, phone number, date/time, duration
       - Status badge (Completed, Failed, etc.)
       - Full transcript in scrollable container
       - Summary if available (placeholder for now)
       - "Back to calls" link

    3. Update calls list page:
       - Make each call row clickable (link to detail page)
       - Add duration column (format as "X min Y sec")
       - Add truncated transcript preview (first 100 chars)
       - Keep existing pagination

    4. Handle empty transcript gracefully:
       - "Transcript not available" message if null/empty
       - This can happen for very short or failed calls
  </action>
  <verify>npm run build succeeds, call detail page renders</verify>
  <done>Call history shows detailed view with transcript on click</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete webhook integration: Vapi events create/update call records, call history shows transcripts</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Ensure VAPI_API_KEY is set in .env
    3. Configure Vapi dashboard:
       - Go to your Vapi dashboard > Assistant settings
       - Set Server URL to your webhook endpoint (use ngrok for local: ngrok http 3000)
       - Server URL should be: https://your-ngrok-url.ngrok.io/api/webhooks/vapi
    4. Make a test call:
       - Call the phone number assigned to your test agent
       - Have a brief conversation (10-20 seconds)
       - End the call
    5. Check webhook logs:
       - Terminal should show "Vapi webhook: status-update" and "Vapi webhook: end-of-call-report"
    6. Check call history:
       - Navigate to /dashboard/calls
       - Verify new call appears with correct agent, duration
       - Click call to see detail page
       - Verify transcript is displayed

    Note: If no Vapi account or phone numbers, verify:
    - Webhook endpoint responds 200 to POST requests
    - Call list page renders without errors
    - Call detail page structure is correct
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] Webhook endpoint at /api/webhooks/vapi handles POST requests
- [ ] Call records created/updated from webhook events
- [ ] Call list page shows duration and transcript preview
- [ ] Call detail page shows full transcript
- [ ] Error handling for missing agents or malformed webhooks
</verification>

<success_criteria>
- All tasks completed
- Human verification approved
- Vapi webhooks create call records in database
- Call history displays transcripts and duration
- Phase 3 complete: Full agent creation → phone assignment → call logging flow works
</success_criteria>

<output>
After completion, create `.planning/phases/03-vapi-integration/03-04-SUMMARY.md`:

# Phase 03-04: Webhook Handler & Call Logging Summary

**[Substantive one-liner]**

## Performance
- **Duration:** X min
- **Started:** [timestamp]
- **Completed:** [timestamp]
- **Tasks:** 4 (3 auto + 1 checkpoint)
- **Files modified:** X

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Deviations from Plan
[Document any auto-fixed issues or design decisions]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
- Phase 3 complete
- Ready for Phase 4: Google Integrations (Calendar booking, Sheets logging)
- Call logging in place for Phase 5 credit deduction

---
*Phase: 03-vapi-integration*
*Completed: [date]*
</output>
