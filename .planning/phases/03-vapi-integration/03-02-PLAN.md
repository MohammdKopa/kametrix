---
phase: 03-vapi-integration
plan: 02
type: execute
---

<objective>
Build comprehensive agent creation wizard that guides users through configuring a fully-functional voice agent.

Purpose: This is the heart of Kametrix - where users create their AI agent with all necessary business knowledge. The wizard ensures agents are fully configured from the start, not half-baked skeletons.
Output: Multi-step wizard UI, agent + Vapi assistant creation on completion, working voice agent.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-vapi-integration/03-RESEARCH.md
@.planning/phases/03-vapi-integration/03-CONTEXT.md
@.planning/phases/03-vapi-integration/03-01-SUMMARY.md

**From CONTEXT.md - What must be nailed:**
- Business knowledge configuration with structured fields (name, hours, services, FAQs, policies)
- Complete wizard flow - every step guides to fully-configured agent
- Working calls at the end (phone assignment is Plan 03)

**From RESEARCH.md - Architecture patterns:**
- Use createBusinessAssistant() from lib/vapi/assistants.ts
- System prompt built from structured business fields
- Voice options: ElevenLabs (marissa default), Vapi voices, Cartesia
- Set maxDurationSeconds: 600

**Relevant source files:**
@src/lib/vapi/index.ts
@src/app/(dashboard)/dashboard/agents/new/page.tsx
@src/components/dashboard/agent-form.tsx
@src/app/api/agents/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create multi-step wizard component with state management</name>
  <files>src/components/wizard/agent-wizard.tsx, src/components/wizard/wizard-progress.tsx, src/types/wizard.ts</files>
  <action>
    1. Create src/types/wizard.ts with wizard state types:
       ```typescript
       interface WizardState {
         step: number;
         businessInfo: {
           businessName: string;
           businessDescription: string;
           businessHours: string; // e.g., "Mon-Fri 9am-5pm"
           services: string[]; // array of service names
         };
         knowledge: {
           faqs: { question: string; answer: string }[];
           policies: string; // refund policy, etc.
         };
         voice: {
           voiceId: string;
           voiceProvider: 'elevenlabs' | 'vapi' | 'cartesia';
         };
         greeting: {
           agentName: string;
           greeting: string;
           endCallMessage: string;
         };
       }
       ```

    2. Create src/components/wizard/wizard-progress.tsx:
       - Visual step indicator (1-5 steps)
       - Shows: Business Info → Knowledge → Voice → Greeting → Review
       - Current step highlighted, completed steps checkmarked
       - Responsive design (horizontal on desktop, compact on mobile)

    3. Create src/components/wizard/agent-wizard.tsx:
       - 'use client' component
       - useState for WizardState with sensible defaults
       - Step navigation: next(), prev(), goToStep(n)
       - Validation before advancing (required fields per step)
       - Renders current step component based on state.step
       - Final step triggers submission
  </action>
  <verify>npm run build succeeds, wizard component renders without errors</verify>
  <done>Wizard shell with step navigation and state management ready for step components</done>
</task>

<task type="auto">
  <name>Task 2: Build wizard step components with structured input fields</name>
  <files>src/components/wizard/steps/business-info-step.tsx, src/components/wizard/steps/knowledge-step.tsx, src/components/wizard/steps/voice-step.tsx, src/components/wizard/steps/greeting-step.tsx, src/components/wizard/steps/review-step.tsx</files>
  <action>
    1. Create src/components/wizard/steps/business-info-step.tsx:
       - Business name (required, text input)
       - Business description (textarea, what the business does)
       - Business hours (text input with placeholder "Mon-Fri 9am-5pm, Sat 10am-2pm")
       - Services offered (dynamic list - add/remove service items)
       - All fields update wizard state on change

    2. Create src/components/wizard/steps/knowledge-step.tsx:
       - FAQs section: Dynamic list of Q&A pairs
         - "Add FAQ" button adds new { question: '', answer: '' }
         - Each FAQ has question input, answer textarea, remove button
         - Pre-populate with 3 empty FAQ slots
       - Policies textarea (refund policy, cancellation policy, etc.)
       - Help text explaining this becomes the agent's knowledge

    3. Create src/components/wizard/steps/voice-step.tsx:
       - Voice provider radio buttons: ElevenLabs (Recommended), Vapi, Cartesia
       - Voice selection dropdown based on provider:
         - ElevenLabs: marissa (default), josh, bella, rachel
         - Vapi: vapi-default
         - Cartesia: sonic-english
       - Audio preview button (placeholder - actual preview requires Vapi web SDK, skip for MVP)
       - Description of each voice option

    4. Create src/components/wizard/steps/greeting-step.tsx:
       - Agent name (what the agent calls itself, e.g., "Sarah")
       - Greeting message (first thing agent says, with {businessName} placeholder)
       - End call message (what agent says when ending call)
       - Preview of full greeting with business name substituted

    5. Create src/components/wizard/steps/review-step.tsx:
       - Summary of all configured options
       - Business info section (name, hours, services list)
       - Knowledge section (FAQ count, policies preview)
       - Voice section (provider, voice name)
       - Greeting preview
       - Edit buttons to jump back to any step
       - "Create Agent" primary button at bottom
  </action>
  <verify>npm run build succeeds, each step component renders with proper form fields</verify>
  <done>All 5 wizard steps implemented with structured input fields matching CONTEXT.md requirements</done>
</task>

<task type="auto">
  <name>Task 3: Implement wizard completion - create agent in DB and Vapi</name>
  <files>src/app/api/agents/route.ts, src/components/wizard/agent-wizard.tsx, src/app/(dashboard)/dashboard/agents/new/page.tsx</files>
  <action>
    1. Update POST /api/agents to handle wizard data:
       - Accept full wizard state structure
       - Call createBusinessAssistant() from lib/vapi to create Vapi assistant
       - Create agent record in DB with vapiAssistantId from Vapi response
       - Return created agent with vapiAssistantId populated
       - Handle Vapi API errors gracefully (return 502 if Vapi fails)
       - Transaction: If Vapi succeeds but DB fails, attempt to delete Vapi assistant

    2. Update agent-wizard.tsx submission:
       - Show loading state during submission ("Creating your agent...")
       - POST to /api/agents with wizard state
       - On success: redirect to /dashboard/agents/[id] (or agents list)
       - On error: Show error message, allow retry
       - Do NOT clear form on error (preserve user input)

    3. Update /dashboard/agents/new/page.tsx:
       - Replace existing AgentForm with AgentWizard component
       - Page title: "Create Your AI Agent"
       - Brief intro text explaining the wizard
  </action>
  <verify>npm run build succeeds, creating agent through wizard creates both DB record and Vapi assistant</verify>
  <done>Wizard creates agent in DB with vapiAssistantId populated from Vapi</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete agent creation wizard with 5 steps: Business Info, Knowledge (FAQs), Voice Selection, Greeting, Review</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Login and navigate to /dashboard/agents/new
    3. Verify wizard displays with step progress indicator
    4. Complete Step 1 (Business Info): Enter business name, description, hours, add 2 services
    5. Complete Step 2 (Knowledge): Add 2 FAQs with Q&A, add some policies text
    6. Complete Step 3 (Voice): Select ElevenLabs and marissa voice
    7. Complete Step 4 (Greeting): Enter agent name, customize greeting
    8. Step 5 (Review): Verify all info displays correctly, click "Create Agent"
    9. Confirm: Agent created successfully, redirects to agent list or detail page
    10. Check database: Agent has vapiAssistantId populated (not null)

    Note: Requires valid VAPI_API_KEY in .env to actually create Vapi assistant.
    If no key, verify error handling works gracefully.
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] Wizard renders all 5 steps with proper navigation
- [ ] Form validation prevents advancing with empty required fields
- [ ] Agent creation populates vapiAssistantId in database
- [ ] Error handling shows user-friendly messages
</verification>

<success_criteria>
- All tasks completed
- Human verification approved
- Users can create fully-configured agents through wizard
- Agents have vapiAssistantId (Vapi assistant created successfully)
- Wizard captures all structured business knowledge per CONTEXT.md
</success_criteria>

<output>
After completion, create `.planning/phases/03-vapi-integration/03-02-SUMMARY.md`:

# Phase 03-02: Agent Creation Wizard Summary

**[Substantive one-liner]**

## Performance
- **Duration:** X min
- **Started:** [timestamp]
- **Completed:** [timestamp]
- **Tasks:** 4 (3 auto + 1 checkpoint)
- **Files modified:** X

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Deviations from Plan
[Document any auto-fixed issues or design decisions]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
- [What's ready for next plan]

---
*Phase: 03-vapi-integration*
*Completed: [date]*
</output>
