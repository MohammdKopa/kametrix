---
phase: 03-vapi-integration
plan: 01
type: execute
---

<objective>
Install Vapi SDK and establish core infrastructure for Vapi API interactions.

Purpose: Create the foundation for all Vapi operations - assistant creation, phone management, and webhook handling depend on this.
Output: VapiClient singleton, typed helper modules, environment configuration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-vapi-integration/03-RESEARCH.md
@.planning/phases/03-vapi-integration/03-CONTEXT.md

**Prior decisions affecting this phase:**
- Prisma 7 with adapter-pg pattern established in Phase 1
- Agent model already has vapiAssistantId field (nullable until Vapi creation)
- PhoneNumber model has vapiPhoneId field

**Relevant source files:**
@src/lib/db.ts
@src/lib/prisma.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Vapi SDK and create client singleton</name>
  <files>package.json, src/lib/vapi/client.ts</files>
  <action>
    1. Install @vapi-ai/server-sdk: `npm install @vapi-ai/server-sdk`
    2. Create src/lib/vapi/client.ts with singleton pattern:
       - Export getVapiClient() function that lazily initializes VapiClient
       - Use process.env.VAPI_API_KEY for token
       - Follow same singleton pattern as prisma.ts
    3. Do NOT create client per request (wastes resources per RESEARCH.md)
  </action>
  <verify>npm run build succeeds, no TypeScript errors</verify>
  <done>VapiClient singleton exists and compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create Vapi helper modules with typed interfaces</name>
  <files>src/lib/vapi/assistants.ts, src/lib/vapi/phone-numbers.ts, src/lib/vapi/types.ts</files>
  <action>
    1. Create src/lib/vapi/types.ts:
       - Define CreateAssistantConfig interface matching our wizard fields (name, businessName, businessHours, services, faqs, voiceId, greeting)
       - Define VapiAssistantResponse type for SDK responses
       - Export types for use across the app

    2. Create src/lib/vapi/assistants.ts:
       - createBusinessAssistant(config: CreateAssistantConfig): Creates Vapi assistant with structured system prompt from business info
       - updateAssistant(assistantId: string, config: Partial<CreateAssistantConfig>): Updates existing assistant
       - deleteAssistant(assistantId: string): Deletes assistant from Vapi
       - Use gpt-4o model, deepgram nova-2 transcriber, configurable voice
       - Set maxDurationSeconds: 600 (10 min max call per RESEARCH.md)
       - Build system prompt from structured fields (business name, hours, services, FAQs)

    3. Create src/lib/vapi/phone-numbers.ts:
       - listPhoneNumbers(): Get all phone numbers from Vapi account
       - assignAssistantToPhoneNumber(phoneNumberId: string, assistantId: string): Update phone number's assistant
       - unassignPhoneNumber(phoneNumberId: string): Remove assistant from phone number
  </action>
  <verify>npm run build succeeds, TypeScript types are correct</verify>
  <done>Helper modules export typed functions for assistant and phone number operations</done>
</task>

<task type="auto">
  <name>Task 3: Environment configuration and index export</name>
  <files>.env.example, src/lib/vapi/index.ts</files>
  <action>
    1. Update .env.example to add:
       ```
       # Vapi Configuration
       VAPI_API_KEY=your_vapi_api_key_here
       ```

    2. Create src/lib/vapi/index.ts barrel export:
       - Export getVapiClient from ./client
       - Export all functions from ./assistants
       - Export all functions from ./phone-numbers
       - Export all types from ./types

    3. Verify imports work: Create a simple test in any existing file (then remove)
  </action>
  <verify>npm run build succeeds, imports from '@/lib/vapi' resolve correctly</verify>
  <done>.env.example documents VAPI_API_KEY, barrel export provides clean import path</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] src/lib/vapi/ directory contains: client.ts, assistants.ts, phone-numbers.ts, types.ts, index.ts
- [ ] .env.example contains VAPI_API_KEY
- [ ] No hardcoded API keys in source files
</verification>

<success_criteria>
- All tasks completed
- Vapi SDK installed and typed
- Helper functions ready for use in wizard and phone management
- Environment variable documented
</success_criteria>

<output>
After completion, create `.planning/phases/03-vapi-integration/03-01-SUMMARY.md`:

# Phase 03-01: Vapi SDK Setup Summary

**[Substantive one-liner]**

## Performance
- **Duration:** X min
- **Started:** [timestamp]
- **Completed:** [timestamp]
- **Tasks:** 3
- **Files modified:** X

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Deviations from Plan
[Document any auto-fixed issues or design decisions]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
- [What's ready for next plan]

---
*Phase: 03-vapi-integration*
*Completed: [date]*
</output>
