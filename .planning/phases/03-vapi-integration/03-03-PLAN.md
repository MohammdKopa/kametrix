---
phase: 03-vapi-integration
plan: 03
type: execute
---

<objective>
Implement phone number pool management and automatic assignment to agents on wizard completion.

Purpose: Users need a phone number assigned to call their agent. We manage a pool of Vapi-provisioned numbers and auto-assign on agent creation.
Output: Admin phone pool sync, automatic phone assignment in wizard, phone number display in agent UI.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-vapi-integration/03-RESEARCH.md
@.planning/phases/03-vapi-integration/03-02-SUMMARY.md

**From CONTEXT.md:**
- Phone numbers auto-assigned from pool - we pick a number for them from available inventory
- When wizard completes, they have a working agent on a real phone number ready to receive calls

**From RESEARCH.md - Phone number patterns:**
- Use listPhoneNumbers() to get Vapi inventory
- assignAssistantToPhoneNumber() to link phone to assistant
- Store vapiPhoneId in our PhoneNumber model
- Vapi charges ~$2-3/month per number

**Prior decisions:**
- PhoneNumber model has status: AVAILABLE | ASSIGNED | RELEASED
- One phone per agent (unique constraint on agentId)

**Relevant source files:**
@src/lib/vapi/phone-numbers.ts
@src/app/api/admin/phone-numbers/route.ts
@prisma/schema.prisma
@src/components/dashboard/agent-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin phone pool sync API</name>
  <files>src/app/api/admin/phone-numbers/sync/route.ts, src/lib/vapi/phone-numbers.ts</files>
  <action>
    1. Update src/lib/vapi/phone-numbers.ts to add:
       - listPhoneNumbers(): Fetch all phone numbers from Vapi account
       - Return array with id, number (E.164), assignedAssistantId

    2. Create POST /api/admin/phone-numbers/sync endpoint:
       - Require admin role
       - Fetch all phone numbers from Vapi via listPhoneNumbers()
       - For each Vapi phone number:
         - If exists in DB by vapiPhoneId: update number, check assignment status
         - If not exists: create new PhoneNumber record with status AVAILABLE
       - For each DB phone number not in Vapi response:
         - Mark as RELEASED (number was removed from Vapi)
       - Return summary: { added: N, updated: N, released: N }

    3. This sync is manual/admin-triggered for now (not automated)
  </action>
  <verify>npm run build succeeds, sync endpoint compiles</verify>
  <done>Admin can sync phone number inventory from Vapi to local database</done>
</task>

<task type="auto">
  <name>Task 2: Integrate phone assignment into agent creation flow</name>
  <files>src/app/api/agents/route.ts, src/lib/vapi/phone-numbers.ts</files>
  <action>
    1. Update src/lib/vapi/phone-numbers.ts to add:
       - assignAssistantToPhoneNumber(vapiPhoneId: string, vapiAssistantId: string): Update Vapi phone to point to assistant
       - Return updated phone number data

    2. Update POST /api/agents route (wizard completion):
       - After creating Vapi assistant successfully:
         a. Find available phone number in DB (status: AVAILABLE, agentId: null)
         b. If no available number: still create agent but warn (agent works without number)
         c. If available: call assignAssistantToPhoneNumber() with Vapi IDs
         d. Update local PhoneNumber: set agentId, status ASSIGNED
         e. Return agent with phoneNumber included in response

    3. Handle edge cases:
       - No available numbers: Return agent with phoneNumber: null, include warning message
       - Vapi assignment fails: Log error, agent still created, phoneNumber remains null
       - DB update fails after Vapi: Attempt to unassign from Vapi (cleanup)

    4. Update agent response to include assigned phone number
  </action>
  <verify>npm run build succeeds, agent creation assigns phone number when available</verify>
  <done>New agents automatically get phone number assigned from available pool</done>
</task>

<task type="auto">
  <name>Task 3: Update UI to show assigned phone numbers and handle unassignment</name>
  <files>src/components/dashboard/agent-card.tsx, src/app/api/agents/[id]/route.ts, src/components/wizard/steps/review-step.tsx</files>
  <action>
    1. Update agent-card.tsx:
       - If phoneNumber exists: Display formatted number (e.g., "(555) 123-4567")
       - If no phoneNumber: Show "No phone assigned" with muted styling
       - Add "Copy number" button next to displayed number
       - Phone number should be prominent - this is what users call to test

    2. Update wizard review-step.tsx completion message:
       - After successful creation, if phone assigned:
         "Your agent is ready! Call {phoneNumber} to test it."
       - If no phone assigned:
         "Agent created, but no phone numbers available. Contact admin."

    3. Update DELETE /api/agents/[id] to handle phone unassignment:
       - When agent is deleted:
         a. If agent has phoneNumber, call unassignPhoneNumber() on Vapi
         b. Update PhoneNumber record: agentId = null, status = AVAILABLE
         c. Phone returns to pool for reuse

    4. Ensure PATCH /api/agents/[id] does NOT allow changing phone assignment
       - Phone assignment is automatic, not user-editable
  </action>
  <verify>npm run build succeeds, agent cards show phone numbers correctly</verify>
  <done>Phone numbers visible in UI, properly unassigned on agent deletion</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] Admin sync endpoint pulls phone numbers from Vapi
- [ ] Agent creation assigns available phone number
- [ ] Agent deletion returns phone to available pool
- [ ] Agent cards display phone numbers prominently
- [ ] Wizard completion shows assigned phone number
</verification>

<success_criteria>
- All tasks completed
- Phone numbers sync from Vapi to local DB
- New agents get phone assigned automatically (when available)
- Phone numbers display in agent cards
- Deleted agents release their phone numbers back to pool
</success_criteria>

<output>
After completion, create `.planning/phases/03-vapi-integration/03-03-SUMMARY.md`:

# Phase 03-03: Phone Number Management Summary

**[Substantive one-liner]**

## Performance
- **Duration:** X min
- **Started:** [timestamp]
- **Completed:** [timestamp]
- **Tasks:** 3
- **Files modified:** X

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Deviations from Plan
[Document any auto-fixed issues or design decisions]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
- [What's ready for next plan]

---
*Phase: 03-vapi-integration*
*Completed: [date]*
</output>
