---
phase: 04-google-integrations
plan: 02
type: execute
---

<objective>
Implement Google Calendar integration with real-time availability checking and appointment booking for Vapi voice agents.

Purpose: Enable voice agents to check calendar availability and book appointments during live calls.
Output: Availability and booking API endpoints, Vapi tool configuration, working calendar integration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-google-integrations/04-RESEARCH.md
@.planning/phases/04-google-integrations/04-CONTEXT.md
@.planning/phases/04-google-integrations/04-01-SUMMARY.md

**Prior decisions affecting this phase:**
- OAuth flow established in 04-01 (getOAuth2ClientForUser helper)
- Vapi SDK singleton pattern from Phase 3
- Agent has vapiAssistantId linking to Vapi

**From RESEARCH.md:**
- Use freebusy.query for availability (handles recurring events, multi-calendar)
- Use events.insert for booking
- Always include timeZone parameter
- Vapi tool calls come via webhook with call metadata

**From CONTEXT.md:**
- Real-time availability checking during live calls
- Single primary calendar per user (no multi-calendar complexity)
- Seamless booking flow is essential

**Relevant source files:**
@src/lib/google/auth.ts
@src/lib/vapi.ts
@src/app/api/webhooks/vapi/route.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Calendar helper functions</name>
  <files>src/lib/google/calendar.ts</files>
  <action>
    1. Create src/lib/google/calendar.ts with:

    getAvailableSlots(oauth2Client, date: Date, timezone: string):
    - Query freebusy for the given date (9am-5pm business hours)
    - Return array of available 30-minute slots
    - Handle timezone correctly (user's timezone from agent config or default)

    bookAppointment(oauth2Client, params: { summary, start, end, attendeeEmail?, description? }):
    - Create calendar event using events.insert
    - Return the created event (with htmlLink for confirmation)
    - Include caller info in description if provided

    Helper considerations:
    - Use 'primary' calendar (per CONTEXT.md - single calendar)
    - Default to 30-minute appointment slots
    - Business hours: 9am-5pm (configurable later)
    - Return human-readable slot times for voice agent to speak
  </action>
  <verify>
    - TypeScript compiles without errors
    - getAvailableSlots and bookAppointment functions exported
    - Functions use proper timezone handling
  </verify>
  <done>Calendar helper with availability check and booking functions implemented</done>
</task>

<task type="auto">
  <name>Task 2: Create Vapi tool endpoints for Calendar</name>
  <files>src/app/api/google/calendar/availability/route.ts, src/app/api/google/calendar/book/route.ts, src/app/api/webhooks/vapi/route.ts</files>
  <action>
    1. Create availability endpoint (POST /api/google/calendar/availability):
       - Accepts: { agentId, date }
       - Gets agent's user, retrieves OAuth client
       - Calls getAvailableSlots
       - Returns available slots in voice-friendly format
       - Handle case where Google not connected (return helpful message)

    2. Create booking endpoint (POST /api/google/calendar/book):
       - Accepts: { agentId, date, time, callerName?, callerPhone?, callerEmail? }
       - Gets agent's user, retrieves OAuth client
       - Calls bookAppointment with details
       - Returns confirmation with event details
       - Handle errors gracefully (slot taken, auth expired, etc.)

    3. Update Vapi webhook to handle tool-calls:
       - Add case for 'tool-calls' message type
       - Route 'check_availability' to availability endpoint
       - Route 'book_appointment' to booking endpoint
       - Return tool results in Vapi's expected format:
         { results: [{ toolCallId, result: string }] }
       - Include agentId from call metadata (stored when call starts)

    Tool call flow:
    - Vapi sends tool-calls webhook with function name and arguments
    - We extract agentId from call.assistantId (lookup agent)
    - Execute the function and return result
    - Vapi speaks the result to caller

    Error handling:
    - Google not connected: "I'm sorry, calendar booking isn't set up yet. Please call back later."
    - No availability: "I don't see any available slots on that date. Would you like to try a different day?"
    - Booking failed: "I wasn't able to book that appointment. Would you like to try a different time?"
  </action>
  <verify>
    - POST /api/google/calendar/availability returns slots or error message
    - POST /api/google/calendar/book creates event or returns error
    - Vapi webhook handles tool-calls message type
    - Tool results returned in correct Vapi format
  </verify>
  <done>Calendar endpoints created, Vapi webhook handles tool calls</done>
</task>

<task type="auto">
  <name>Task 3: Update agent creation to include Calendar tools</name>
  <files>src/lib/vapi.ts, src/app/api/agents/route.ts</files>
  <action>
    1. Update createVapiAssistant in src/lib/vapi.ts to include tools:
       - Add check_availability tool definition:
         - name: "check_availability"
         - description: "Check calendar availability for a given date"
         - parameters: { date: string (YYYY-MM-DD format) }
       - Add book_appointment tool definition:
         - name: "book_appointment"
         - description: "Book an appointment on the calendar"
         - parameters: { date, time, callerName?, callerPhone?, callerEmail? }

    2. Tools should only be added if user has Google connected:
       - Check user.googleConnectedAt before adding tools
       - If not connected, create agent without calendar tools
       - Log that calendar tools were skipped

    3. Update system prompt template to mention calendar capabilities:
       - If tools enabled: "You can check availability and book appointments..."
       - If not enabled: Don't mention calendar features

    Note: Existing agents won't have tools until recreated. This is acceptable for MVP.
  </action>
  <verify>
    - New agents created with Google connected include calendar tools
    - New agents without Google connected don't include calendar tools
    - Tool definitions match Vapi's expected format
  </verify>
  <done>Agent creation includes calendar tools when Google is connected</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Calendar integration with Vapi tool calls for availability and booking</what-built>
  <how-to-verify>
    1. Ensure Google is connected for your test user (use Connect Google button)
    2. Create a new agent (so it has calendar tools)
    3. Make a test call to the agent's phone number
    4. Ask about availability: "Do you have any appointments available tomorrow?"
    5. Try to book: "I'd like to book an appointment at 10am"
    6. Check your Google Calendar - appointment should appear
    7. Verify the event has caller info in the description
  </how-to-verify>
  <resume-signal>Type "approved" if calendar booking works end-to-end, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Calendar availability endpoint returns slots
- [ ] Calendar booking endpoint creates events
- [ ] Vapi tool calls are handled correctly
- [ ] New agents include calendar tools when Google connected
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Voice agent can check availability during call
- Voice agent can book appointments during call
- Appointments appear in user's Google Calendar
</success_criteria>

<output>
After completion, create `.planning/phases/04-google-integrations/04-02-SUMMARY.md`
</output>
