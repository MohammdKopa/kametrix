---
phase: 04-google-integrations
plan: 01
type: execute
---

<objective>
Set up Google OAuth2 flow with secure token storage and user-facing connection UI.

Purpose: Enable users to connect their Google account so Calendar and Sheets integrations can function.
Output: Working OAuth flow, encrypted token storage, "Connect Google" button in dashboard.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-google-integrations/04-RESEARCH.md
@.planning/phases/04-google-integrations/04-CONTEXT.md

**Prior decisions affecting this phase:**
- Prisma 7 with adapter-pg pattern established in Phase 1
- Auth uses cookie-based sessions (Phase 1)
- Dashboard layout with settings area exists (Phase 2)

**From RESEARCH.md:**
- Use `googleapis` and `google-auth-library` (official Google libraries)
- Must use `access_type: 'offline'` and `prompt: 'consent'` to get refresh token
- Store encrypted refresh token in database
- Listen for `tokens` event to catch refresh token updates

**Relevant source files:**
@prisma/schema.prisma
@src/lib/auth.ts
@src/app/(dashboard)/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Google libraries and update schema</name>
  <files>package.json, prisma/schema.prisma</files>
  <action>
    1. Install dependencies: `npm install googleapis google-auth-library`
    2. Add fields to User model in schema.prisma:
       - googleRefreshToken: String? (encrypted refresh token)
       - googleSheetId: String? (auto-created logging spreadsheet ID)
       - googleConnectedAt: DateTime? (when Google was connected)
    3. Generate migration with `npx prisma migrate diff --from-schema-datamodel prisma/schema.prisma --to-schema-datasource prisma/schema.prisma --script > prisma/migrations/$(date +%Y%m%d%H%M%S)_add_google_fields/migration.sql`
    4. Apply migration to database
    5. Regenerate Prisma client
  </action>
  <verify>
    - `npm ls googleapis google-auth-library` shows both installed
    - `npx prisma validate` passes
    - User type includes googleRefreshToken, googleSheetId, googleConnectedAt fields
  </verify>
  <done>Dependencies installed, schema updated with Google fields, migration applied</done>
</task>

<task type="auto">
  <name>Task 2: Create Google OAuth helper and API routes</name>
  <files>src/lib/google/auth.ts, src/app/api/auth/google/route.ts, src/app/api/auth/google/callback/route.ts, .env.example</files>
  <action>
    1. Create src/lib/google/auth.ts with:
       - createOAuth2Client(refreshToken?: string) factory function
       - getAuthUrl() that generates OAuth URL with:
         - access_type: 'offline' (CRITICAL for refresh token)
         - prompt: 'consent' (CRITICAL to always get refresh token)
         - scope: calendar, spreadsheets
       - Simple encryption/decryption helpers for token storage (use node:crypto with AES-256-GCM)
       - getOAuth2ClientForUser(userId) that retrieves and decrypts stored token

    2. Create src/app/api/auth/google/route.ts (GET):
       - Verify user is logged in via session
       - Generate OAuth URL and redirect to Google

    3. Create src/app/api/auth/google/callback/route.ts (GET):
       - Exchange code for tokens
       - Encrypt refresh_token
       - Update user record with googleRefreshToken and googleConnectedAt
       - Redirect to dashboard with success message
       - Handle errors gracefully (redirect with error param)

    4. Add to .env.example:
       - GOOGLE_CLIENT_ID
       - GOOGLE_CLIENT_SECRET
       - GOOGLE_ENCRYPTION_KEY (32-byte hex for AES-256)

    Environment variables needed:
    - GOOGLE_CLIENT_ID: From Google Cloud Console
    - GOOGLE_CLIENT_SECRET: From Google Cloud Console
    - GOOGLE_ENCRYPTION_KEY: Generate with `openssl rand -hex 32`
  </action>
  <verify>
    - TypeScript compiles without errors
    - OAuth routes exist at /api/auth/google and /api/auth/google/callback
    - Auth helper exports createOAuth2Client, getAuthUrl, getOAuth2ClientForUser
  </verify>
  <done>OAuth helper created, initiate and callback routes working, token encryption implemented</done>
</task>

<task type="auto">
  <name>Task 3: Add Connect Google button to dashboard</name>
  <files>src/app/(dashboard)/dashboard/page.tsx, src/components/dashboard/google-connect-button.tsx</files>
  <action>
    1. Create src/components/dashboard/google-connect-button.tsx:
       - Show "Connect Google" button if user.googleConnectedAt is null
       - Show "Google Connected" with green checkmark + disconnect option if connected
       - Button links to /api/auth/google to initiate OAuth flow
       - Include Google logo/icon for recognition

    2. Update dashboard page to:
       - Fetch user's googleConnectedAt status
       - Display GoogleConnectButton component in a prominent location
       - Show success/error messages from OAuth callback (via URL params)

    Style notes:
    - Match existing dashboard styling (Tailwind)
    - Use lucide-react icons (already installed)
    - Keep it simple - one clear CTA
  </action>
  <verify>
    - Dashboard shows Connect Google button for users without Google connected
    - Dashboard shows Connected status for users with Google connected
    - Clicking Connect Google initiates OAuth flow
  </verify>
  <done>Connect Google UI visible in dashboard, OAuth flow can be initiated from UI</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx prisma validate` passes
- [ ] OAuth initiate route redirects to Google consent screen
- [ ] OAuth callback route stores encrypted token and redirects to dashboard
- [ ] Dashboard shows Google connection status
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- User can initiate Google OAuth from dashboard
- Tokens stored encrypted in database
- Connection status visible in dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/04-google-integrations/04-01-SUMMARY.md`
</output>
