---
phase: 04-google-integrations
plan: 03
type: execute
---

<objective>
Implement Google Sheets integration for automatic call logging with zero manual setup.

Purpose: Every completed call automatically logs to the user's Google Sheet for record-keeping and analysis.
Output: Auto-created logging spreadsheet, call logging on webhook, integration status in dashboard.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-google-integrations/04-RESEARCH.md
@.planning/phases/04-google-integrations/04-CONTEXT.md
@.planning/phases/04-google-integrations/04-01-SUMMARY.md
@.planning/phases/04-google-integrations/04-02-SUMMARY.md

**Prior decisions affecting this phase:**
- OAuth flow with googleSheetId field established in 04-01
- Vapi webhook handles end-of-call-report (Phase 3)
- User model has googleRefreshToken and googleSheetId

**From RESEARCH.md:**
- Use spreadsheets.create to auto-create logging sheet
- Use values.append to add rows (INSERT_ROWS mode)
- Store spreadsheet ID in user record for reuse
- Sheet should be created on first call, not on Google connect

**From CONTEXT.md:**
- Auto-create or auto-find sheet - zero manual setup
- Log: caller info, duration, outcome, notes, appointment details
- Connect Google and logging "just works"

**Relevant source files:**
@src/lib/google/auth.ts
@src/app/api/webhooks/vapi/route.ts
@src/lib/calls.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Sheets helper functions</name>
  <files>src/lib/google/sheets.ts</files>
  <action>
    1. Create src/lib/google/sheets.ts with:

    getOrCreateLogSheet(oauth2Client, userId: string):
    - Check if user.googleSheetId exists in database
    - If exists, verify sheet still accessible (try to get spreadsheet metadata)
    - If not exists or inaccessible, create new spreadsheet:
      - Title: "Kametrix Call Logs"
      - First sheet named "Calls"
      - Header row: Date, Time, Caller, Agent, Duration, Status, Summary, Appointment Booked
    - Store spreadsheet ID in user.googleSheetId
    - Return spreadsheet ID

    appendCallLog(oauth2Client, sheetId: string, callData):
    - Append a new row to the Calls sheet
    - Format date/time in readable format
    - Duration as "Xm Ys" format
    - Status as human-readable (Completed, Failed, etc.)
    - Return success/failure

    Call log columns:
    - Date: YYYY-MM-DD
    - Time: HH:MM AM/PM
    - Caller: Phone number
    - Agent: Agent name
    - Duration: "2m 15s" format
    - Status: Completed/Failed/No Answer
    - Summary: AI-generated summary (if available)
    - Appointment Booked: Yes/No or datetime if booked

    Error handling:
    - If Google disconnected, skip silently (don't fail the webhook)
    - If sheet deleted, recreate it
    - Log errors but don't throw
  </action>
  <verify>
    - TypeScript compiles without errors
    - getOrCreateLogSheet and appendCallLog functions exported
    - Functions handle edge cases (no token, sheet deleted)
  </verify>
  <done>Sheets helper with auto-create and append functions implemented</done>
</task>

<task type="auto">
  <name>Task 2: Hook Sheets logging into Vapi webhook</name>
  <files>src/app/api/webhooks/vapi/route.ts, src/lib/calls.ts</files>
  <action>
    1. Update handleEndOfCallReport in Vapi webhook:
       - After saving call to database, attempt Sheets logging
       - Get user from agent relationship
       - Check if user.googleRefreshToken exists
       - If Google connected:
         - Get OAuth client for user
         - Get or create log sheet
         - Append call log with all available data
       - If not connected, skip silently

    2. Add logCallToSheets function to src/lib/calls.ts:
       - Takes: userId, callData (from webhook)
       - Handles all Sheets logic
       - Returns void (fire-and-forget, non-blocking)
       - Catches and logs all errors without throwing

    3. Webhook flow:
       - Receive end-of-call-report
       - Save call to database (existing)
       - logCallToSheets(userId, callData) - async, don't await
       - Return { received: true } immediately

    Non-blocking is critical:
    - Vapi has 7.5s timeout
    - Sheets logging should not delay webhook response
    - Use Promise.resolve().then() or setImmediate pattern

    Data to log:
    - Date/Time from call.startedAt
    - Caller from call.customer.number
    - Agent name from agent lookup
    - Duration from extractCallDuration
    - Status from mapEndedReasonToStatus
    - Summary from artifact.summary (if available) or transcript snippet
    - Appointment: Check if any book_appointment tool was called (from artifact.toolCalls)
  </action>
  <verify>
    - Webhook still responds quickly (< 1s)
    - Calls are logged to Sheets when Google is connected
    - Webhook doesn't fail when Google is not connected
    - Errors in Sheets logging don't affect call record saving
  </verify>
  <done>Call logging integrated into webhook, non-blocking, graceful failures</done>
</task>

<task type="auto">
  <name>Task 3: Add integration status to dashboard</name>
  <files>src/components/dashboard/google-connect-button.tsx, src/app/(dashboard)/dashboard/page.tsx</files>
  <action>
    1. Update GoogleConnectButton component to show integration status:
       - When connected, show:
         - Green checkmark with "Google Connected"
         - "Calendar: Ready" indicator
         - "Call Logging: Ready" indicator (or "Call Logging: Sheet will be created on first call")
         - If googleSheetId exists, show "View Call Log" link to Google Sheets
       - Add "Disconnect" option (clears tokens, shows confirmation first)

    2. Update dashboard page:
       - Fetch full Google integration status (googleConnectedAt, googleSheetId)
       - Pass to GoogleConnectButton

    3. Create disconnect endpoint (optional but nice):
       - POST /api/auth/google/disconnect
       - Clears googleRefreshToken, googleSheetId, googleConnectedAt
       - Redirects to dashboard with message

    Visual design:
    - Use existing card/panel styling from dashboard
    - Green for connected, gray for not connected
    - Keep it compact but informative
  </action>
  <verify>
    - Connected users see full integration status
    - Sheet link visible when sheet has been created
    - Disconnect option works and clears tokens
  </verify>
  <done>Integration status visible in dashboard with sheet link</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Google Sheets integration with automatic call logging</what-built>
  <how-to-verify>
    1. Ensure Google is connected for your test user
    2. Make a test call to an agent
    3. Complete the call (hang up after a brief conversation)
    4. Check dashboard - "View Call Log" link should appear
    5. Click the link - Google Sheet should open with:
       - Header row (Date, Time, Caller, Agent, Duration, Status, Summary, Appointment)
       - At least one call log entry
    6. Verify call data is accurate (duration, status, etc.)
    7. Make another call - verify it appends a new row (doesn't overwrite)
  </how-to-verify>
  <resume-signal>Type "approved" if Sheets logging works correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Sheets helper creates spreadsheet correctly
- [ ] Webhook logs calls to Sheets without blocking
- [ ] Dashboard shows integration status
- [ ] Sheet link works when sheet exists
- [ ] Multiple calls append correctly (no overwrites)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Completed calls automatically log to Google Sheets
- Users can view their call logs via sheet link
- Zero manual sheet setup required
- Phase 4 complete: Full Google integrations operational
</success_criteria>

<output>
After completion, create `.planning/phases/04-google-integrations/04-03-SUMMARY.md`

Include in summary:
- Phase 4 complete status
- Ready for Phase 5: Payments & Credits
</output>
