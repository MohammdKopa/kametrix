---
phase: 15-security-hardening
plan: 01
type: execute
---

<objective>
Add rate limiting and webhook signature verification to protect APIs from abuse.

Purpose: Harden public API endpoints against brute force attacks, spam, and unauthorized webhook calls.
Output: Rate-limited auth/generate endpoints, verified Vapi webhooks, security utilities.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONCERNS.md
@.planning/phases/15-security-hardening/15-RESEARCH.md
@.planning/phases/15-security-hardening/15-CONTEXT.md

**Codebase constraints:**
- Next.js App Router with route handlers
- Self-hosted (not serverless) - in-memory rate limiting acceptable
- Existing Stripe webhook verification pattern to follow
- German error messages for user-facing responses

**Prior decisions affecting this phase:**
- Lazy initialization pattern for external clients (Phase 6)
- Session-based auth with HTTP-only cookies (Phase 1)

**Security concerns being addressed (from CONCERNS.md):**
- Vapi webhook signature verification not implemented
- Rate limiting not implemented
- API endpoints vulnerable to abuse/DoS

**Relevant source files:**
@src/app/api/webhooks/stripe/route.ts (reference for signature verification pattern)
@src/app/api/webhooks/vapi/route.ts (needs signature verification)
@src/app/api/auth/login/route.ts (needs rate limiting)
@src/app/api/auth/register/route.ts (needs rate limiting)
@src/app/api/generate/route.ts (needs rate limiting - expensive AI operation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rate limiter library</name>
  <files>src/lib/rate-limit.ts, package.json</files>
  <action>
    1. Install rate-limiter-flexible: `npm install rate-limiter-flexible`
    2. Create src/lib/rate-limit.ts with:
       - `authLimiter`: 5 points per 15 minutes, 15-min block (brute force protection)
       - `registerLimiter`: 3 points per hour (spam prevention)
       - `generateLimiter`: 10 points per minute (AI cost protection)
       - `getClientIp(request)`: Extract IP from x-forwarded-for, x-real-ip, or fallback to 'unknown'
       - `applyRateLimit(limiter, key)`: Returns NextResponse with 429 if exceeded, null if allowed
    3. Use RateLimiterMemory (not PostgreSQL) - simpler for single-server deployment
    4. Fail open on errors (allow request if rate limiter fails) to prevent DoS
    5. Include X-RateLimit-* and Retry-After headers in 429 responses
    6. German error message: "Zu viele Anfragen. Bitte warten Sie."
  </action>
  <verify>
    - npm install succeeds
    - TypeScript compiles: `npx tsc --noEmit`
    - rate-limiter-flexible in package.json dependencies
  </verify>
  <done>Rate limiter library created with auth, register, and generate limiters plus helper functions</done>
</task>

<task type="auto">
  <name>Task 2: Add Vapi webhook signature verification</name>
  <files>src/lib/webhook-auth.ts, src/app/api/webhooks/vapi/route.ts, .env.example</files>
  <action>
    1. Create src/lib/webhook-auth.ts with:
       - `verifyVapiSignature(payload, signature, secret)`: HMAC-SHA256 verification
       - Use crypto.createHmac('sha256', secret).update(payload, 'utf8').digest('hex')
       - Use crypto.timingSafeEqual for comparison (prevents timing attacks)
       - Return false if signature or secret is missing/empty

    2. Update src/app/api/webhooks/vapi/route.ts:
       - CRITICAL: Change `await req.json()` to `await req.text()` to get raw body FIRST
       - Get signature from `req.headers.get('x-vapi-signature')`
       - Verify signature if VAPI_WEBHOOK_SECRET is configured
       - Return 401 with { error: 'Invalid signature' } if verification fails
       - Parse JSON AFTER verification: `JSON.parse(body)`
       - Log verification failure (but not the secret itself)

    3. Add VAPI_WEBHOOK_SECRET to .env.example with comment explaining how to get it from Vapi dashboard

    Note: Make verification optional (only if secret configured) so existing deployments don't break immediately.
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit`
    - Build succeeds: `npm run build`
    - Vapi webhook still handles events (test manually if possible)
  </verify>
  <done>Vapi webhook verifies signatures when VAPI_WEBHOOK_SECRET is configured, fails gracefully without it</done>
</task>

<task type="auto">
  <name>Task 3: Apply rate limiting to auth and generate routes</name>
  <files>src/app/api/auth/login/route.ts, src/app/api/auth/register/route.ts, src/app/api/generate/route.ts</files>
  <action>
    1. Update src/app/api/auth/login/route.ts:
       - Import { authLimiter, applyRateLimit, getClientIp } from '@/lib/rate-limit'
       - At start of POST handler: get IP, apply authLimiter with key `login:${ip}`
       - Return early if rate limited (applyRateLimit returns NextResponse)

    2. Update src/app/api/auth/register/route.ts:
       - Import { registerLimiter, applyRateLimit, getClientIp } from '@/lib/rate-limit'
       - At start of POST handler: get IP, apply registerLimiter with key `register:${ip}`
       - Return early if rate limited

    3. Update src/app/api/generate/route.ts:
       - Import { generateLimiter, applyRateLimit, getClientIp } from '@/lib/rate-limit'
       - At start of POST handler: get IP, apply generateLimiter with key `generate:${ip}`
       - Return early if rate limited

    Keep existing logic unchanged - rate limiting is added at the very start of each handler.
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit`
    - Build succeeds: `npm run build`
    - All three routes still function (manual test if possible)
  </verify>
  <done>Login (5/15min), register (3/hour), and generate (10/min) endpoints are rate limited by IP</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] No new TypeScript errors introduced
- [ ] rate-limiter-flexible installed in package.json
- [ ] VAPI_WEBHOOK_SECRET documented in .env.example
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Rate limiting library created with 3 limiter types
- Vapi webhook verifies signatures (when secret configured)
- Auth routes (login, register) and generate route are rate limited
- No breaking changes to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/15-security-hardening/15-01-SUMMARY.md`:

# Phase 15 Plan 01: Security Hardening Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 15 complete, ready for Phase 16: Auth UI Polish
</output>
