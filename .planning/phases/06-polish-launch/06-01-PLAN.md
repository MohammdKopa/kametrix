---
phase: 06-polish-launch
plan: 01
type: execute
---

<objective>
Set up email notification system with welcome and low credit warning emails.

Purpose: Keep users informed about account activity and credit status via reliable email delivery.
Output: Working email system with nodemailer SMTP transport, welcome email on signup, low credit email on balance warning.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-polish-launch/06-CONTEXT.md

**Prior decisions affecting this phase:**
- Own SMTP server for email delivery (not Gmail SMTP, not third-party service per CONTEXT.md)
- Plain functional emails, no fancy branded templates
- Low balance threshold is $5 / 500 cents (from Phase 5)

**Relevant source files:**
@src/app/api/auth/register/route.ts - Registration endpoint to add welcome email
@src/lib/credits-utils.ts - Low balance utilities (isLowBalance, LOW_BALANCE_THRESHOLD_CENTS)
@src/app/api/webhooks/vapi/route.ts - Call completion webhook that deducts credits
@.env.example - Environment variable template
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email service with nodemailer SMTP transport</name>
  <files>src/lib/email.ts, .env.example, .env.production.example</files>
  <action>
    1. Install nodemailer: `npm install nodemailer` and `npm install -D @types/nodemailer`
    2. Create src/lib/email.ts with:
       - SMTP transport using env vars: SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, SMTP_FROM
       - Lazy initialization pattern (like Stripe client) to prevent build errors when env vars not set
       - sendEmail function accepting { to, subject, text, html? }
       - Error handling with console.error (don't throw - email failure shouldn't break app flow)
    3. Add SMTP env vars to .env.example and .env.production.example with comments
    4. Use secure: true for port 465, false otherwise (standard SMTP behavior)
  </action>
  <verify>npm run build succeeds, no TypeScript errors</verify>
  <done>Email service created with SMTP transport, env vars documented</done>
</task>

<task type="auto">
  <name>Task 2: Add welcome email on user registration</name>
  <files>src/app/api/auth/register/route.ts, src/lib/email.ts</files>
  <action>
    1. Add sendWelcomeEmail function to src/lib/email.ts:
       - Takes { email, name? }
       - Subject: "Welcome to Kametrix"
       - Plain text body: Welcome message, brief overview of getting started (create agent, add credits)
       - Keep it simple and functional per CONTEXT.md
    2. In register/route.ts, after successful user creation and session:
       - Call sendWelcomeEmail(user.email, user.name) - don't await (fire and forget)
       - Log success/failure but don't fail registration if email fails
  </action>
  <verify>Register new user, check server logs for email send attempt</verify>
  <done>Welcome email sent on registration, doesn't block registration on failure</done>
</task>

<task type="auto">
  <name>Task 3: Add low credit warning email</name>
  <files>src/lib/email.ts, src/app/api/webhooks/vapi/route.ts</files>
  <action>
    1. Add sendLowCreditEmail function to src/lib/email.ts:
       - Takes { email, name?, currentBalance: number (cents), graceCreditsUsed: number }
       - Subject: "Low Credit Balance - Kametrix"
       - Body: Current balance, warning about grace period if applicable, link to buy more credits
       - Format balance as "$X.XX (~Y min)" using formatBalance pattern from credits-utils
    2. In vapi webhook (call completion handler), after credit deduction:
       - Check if user now has low balance using isLowBalance(user.creditBalance)
       - If low and NOT already in grace (graceCreditsUsed === 0), send the email
       - This ensures we send once when crossing threshold, not on every call
       - Fire and forget - don't await, log errors
    3. Need to fetch user email in webhook - add select for email in the user query
  </action>
  <verify>After call that brings balance below $5, check logs for low credit email attempt</verify>
  <done>Low credit email sent when balance drops below threshold, sent only once per low-balance event</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Email service initializes without errors when SMTP vars are set
- [ ] Registration works and logs welcome email send attempt
- [ ] Credit deduction triggers low balance email when threshold crossed
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Email service created with proper error handling
- Welcome email fires on registration
- Low credit email fires when balance crosses $5 threshold
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish-launch/06-01-SUMMARY.md`
</output>
