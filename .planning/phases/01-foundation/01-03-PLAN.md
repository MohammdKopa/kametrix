---
phase: 01-foundation
plan: 03
type: execute
---

<objective>
Implement email/password authentication with session management.

Purpose: Enable user registration, login, and protected routes for the application.
Output: Working auth system with register/login/logout API routes and middleware for protected pages.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@prisma/schema.prisma

**Prior decisions:**
- Auth: Email/password only (no social login for v1)
- Session-based auth with database-stored sessions

**Available models from Plan 01-02:**
- User (id, email, passwordHash, name, role, creditBalance, graceCreditsUsed)
- Session (id, userId, token, expiresAt)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth utility functions</name>
  <files>src/lib/auth.ts, src/lib/password.ts</files>
  <action>
    Install dependencies: `npm install bcryptjs && npm install -D @types/bcryptjs`

    Create src/lib/password.ts:
    - hashPassword(password: string): Promise<string> - bcrypt hash with cost 12
    - verifyPassword(password: string, hash: string): Promise<boolean> - bcrypt compare

    Create src/lib/auth.ts:
    - generateSessionToken(): string - crypto.randomBytes(32).toString('hex')
    - createSession(userId: string): Promise<Session> - create session in DB, return token
    - validateSession(token: string): Promise<{user: User, session: Session} | null>
      - Find session by token
      - Check not expired
      - Return user and session if valid
    - invalidateSession(token: string): Promise<void> - delete session from DB
    - getSessionFromCookies(cookies: ReadonlyRequestCookies): string | null
    - setSessionCookie(response: NextResponse, token: string, expiresAt: Date): void
    - clearSessionCookie(response: NextResponse): void

    Session duration: 7 days
    Cookie name: "session"
    Cookie settings: httpOnly, secure (in production), sameSite: "lax", path: "/"

    Use Node.js built-in crypto module (not external libraries) for token generation.
  </action>
  <verify>
    - Files exist with all functions exported
    - `npx tsc --noEmit` passes
  </verify>
  <done>Auth utilities created: password hashing, session management, cookie helpers</done>
</task>

<task type="auto">
  <name>Task 2: Create auth API routes</name>
  <files>src/app/api/auth/register/route.ts, src/app/api/auth/login/route.ts, src/app/api/auth/logout/route.ts, src/app/api/auth/me/route.ts</files>
  <action>
    Create POST /api/auth/register:
    - Accept: { email, password, name? }
    - Validate: email format, password min 8 chars
    - Check email not already registered
    - Hash password, create user with role USER
    - Create session and set cookie
    - Return: { user: { id, email, name, role } }
    - Errors: 400 (validation), 409 (email exists)

    Create POST /api/auth/login:
    - Accept: { email, password }
    - Find user by email
    - Verify password
    - Create session and set cookie
    - Return: { user: { id, email, name, role } }
    - Errors: 400 (validation), 401 (invalid credentials)

    Create POST /api/auth/logout:
    - Get session from cookie
    - Invalidate session in DB
    - Clear session cookie
    - Return: { success: true }

    Create GET /api/auth/me:
    - Get session from cookie
    - Validate session
    - Return: { user: { id, email, name, role, creditBalance } }
    - Errors: 401 (not authenticated)

    All routes should use NextResponse for responses.
    Use try/catch for error handling, return proper JSON errors.
  </action>
  <verify>
    - All route files exist
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
  </verify>
  <done>Auth API routes created: register, login, logout, me</done>
</task>

<task type="auto">
  <name>Task 3: Create auth middleware and protected route helpers</name>
  <files>src/middleware.ts, src/lib/auth-guard.ts, src/types/index.ts</files>
  <action>
    Update src/types/index.ts with auth types:
    - AuthUser: { id, email, name, role, creditBalance }
    - SessionUser: User from Prisma without passwordHash

    Create src/lib/auth-guard.ts:
    - getAuthUser(request: NextRequest): Promise<AuthUser | null>
      - Get token from cookie
      - Validate session
      - Return user data or null
    - requireAuth(request: NextRequest): Promise<AuthUser>
      - Call getAuthUser
      - Throw/return error response if not authenticated
    - requireAdmin(request: NextRequest): Promise<AuthUser>
      - Call requireAuth
      - Check role === 'ADMIN'
      - Throw/return error response if not admin

    Create src/middleware.ts:
    - Match paths: /dashboard/:path*, /admin/:path*, /api/dashboard/:path*, /api/admin/:path*
    - For matched paths:
      - Check session cookie exists
      - If no session, redirect to /login (for pages) or return 401 (for API)
    - Skip auth check for: /api/auth/*, /login, /register, /, /api/webhooks/*

    Export config with matcher for protected routes.

    Note: Middleware runs on Edge, so use only Edge-compatible APIs.
    The middleware does a lightweight check (cookie exists), full validation happens in route handlers.
  </action>
  <verify>
    - src/middleware.ts exists with proper matcher config
    - src/lib/auth-guard.ts exports helper functions
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
  </verify>
  <done>Auth middleware protects dashboard/admin routes, auth-guard helpers available for API routes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npx tsc --noEmit` passes
- [ ] All auth routes exist and export handlers
- [ ] Middleware configured for protected routes
- [ ] Auth utilities properly handle password hashing and sessions
- [ ] Manual test: Can register, login, access /api/auth/me, logout
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Users can register with email/password
- Users can login and receive session cookie
- Protected routes redirect unauthenticated users
- /api/auth/me returns current user data
- Phase 1 Foundation complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
