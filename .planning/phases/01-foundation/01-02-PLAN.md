---
phase: 01-foundation
plan: 02
type: execute
---

<objective>
Define complete database schema for Kametrix: users, agents, calls, credits, and phone numbers.

Purpose: Establish the data model that supports all application features.
Output: Prisma schema with all models, migrations applied, types generated.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

**Prior decisions:**
- Voice provider: Vapi (agents will store Vapi assistant IDs)
- Billing: Credit packs with grace period
- Phone numbers: Kametrix provisions (not BYOD)
- Auth: Email/password only

**Data model requirements from PROJECT.md:**
- Users with authentication
- Agents with configuration (linked to Vapi assistants)
- Calls with logging (duration, credits used, status)
- Credit packs for purchase
- Credit transactions for tracking
- Phone numbers provisioned by Kametrix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create User and Agent models</name>
  <files>prisma/schema.prisma</files>
  <action>
    Add User model:
    - id: String @id @default(cuid())
    - email: String @unique
    - passwordHash: String
    - name: String?
    - role: Role enum (USER, ADMIN) @default(USER)
    - creditBalance: Int @default(0) - current credit balance in cents
    - graceCreditsUsed: Int @default(0) - credits used during grace period
    - createdAt: DateTime @default(now())
    - updatedAt: DateTime @updatedAt
    - Relations: agents, calls, creditTransactions, sessions

    Add Role enum: USER, ADMIN

    Add Agent model:
    - id: String @id @default(cuid())
    - userId: String (foreign key to User)
    - name: String - display name
    - vapiAssistantId: String? @unique - Vapi's assistant ID (null until created in Vapi)
    - greeting: String - initial greeting message
    - systemPrompt: String @db.Text - AI behavior instructions
    - voiceId: String - Vapi voice identifier
    - businessName: String - for context in conversations
    - businessDescription: String? @db.Text
    - isActive: Boolean @default(true)
    - createdAt: DateTime @default(now())
    - updatedAt: DateTime @updatedAt
    - Relations: user, calls, phoneNumber

    Add Session model for auth:
    - id: String @id @default(cuid())
    - userId: String
    - token: String @unique
    - expiresAt: DateTime
    - createdAt: DateTime @default(now())
    - Relation: user

    Use @db.VarChar(255) for email to prevent index issues on MySQL (though we use PostgreSQL, good practice).
  </action>
  <verify>npx prisma validate passes</verify>
  <done>User, Agent, Session models defined with all fields and relations</done>
</task>

<task type="auto">
  <name>Task 2: Create Call, Credit, and PhoneNumber models</name>
  <files>prisma/schema.prisma</files>
  <action>
    Add Call model:
    - id: String @id @default(cuid())
    - agentId: String
    - userId: String (denormalized for easier queries)
    - vapiCallId: String? @unique - Vapi's call ID
    - phoneNumber: String - caller's phone number
    - status: CallStatus enum
    - startedAt: DateTime
    - endedAt: DateTime?
    - durationSeconds: Int?
    - creditsUsed: Int @default(0)
    - summary: String? @db.Text - AI-generated call summary
    - transcript: String? @db.Text - full transcript
    - createdAt: DateTime @default(now())
    - Relations: agent, user

    Add CallStatus enum: RINGING, IN_PROGRESS, COMPLETED, FAILED, NO_ANSWER

    Add CreditPack model (purchasable credit packages):
    - id: String @id @default(cuid())
    - name: String (e.g., "Starter Pack")
    - credits: Int - amount of credits
    - priceInCents: Int - price in cents
    - stripePriceId: String? @unique - Stripe price ID
    - isActive: Boolean @default(true)
    - createdAt: DateTime @default(now())
    - updatedAt: DateTime @updatedAt

    Add CreditTransaction model:
    - id: String @id @default(cuid())
    - userId: String
    - type: TransactionType enum
    - amount: Int - positive for purchases, negative for usage
    - balanceAfter: Int - balance after this transaction
    - description: String?
    - callId: String? - if deducted for a call
    - stripePaymentId: String? - if from Stripe payment
    - createdAt: DateTime @default(now())
    - Relation: user

    Add TransactionType enum: PURCHASE, CALL_USAGE, ADMIN_ADJUSTMENT, GRACE_USAGE

    Add PhoneNumber model:
    - id: String @id @default(cuid())
    - number: String @unique - E.164 format
    - agentId: String? @unique - one phone per agent
    - twilioSid: String? @unique - Twilio phone number SID
    - vapiPhoneId: String? @unique - Vapi phone number ID
    - status: PhoneStatus enum
    - createdAt: DateTime @default(now())
    - updatedAt: DateTime @updatedAt
    - Relation: agent

    Add PhoneStatus enum: AVAILABLE, ASSIGNED, RELEASED
  </action>
  <verify>npx prisma validate passes</verify>
  <done>Call, CreditPack, CreditTransaction, PhoneNumber models defined</done>
</task>

<task type="auto">
  <name>Task 3: Generate Prisma client and create initial migration</name>
  <files>prisma/migrations/*, src/lib/db.ts</files>
  <action>
    1. Ensure DATABASE_URL is set in .env (create .env from .env.example if needed)
       - For local dev: postgresql://postgres:postgres@localhost:5432/kametrix
    2. Run `npx prisma generate` to generate Prisma client with all types
    3. Run `npx prisma migrate dev --name init` to create and apply initial migration
    4. Verify the migration was created in prisma/migrations/

    If database doesn't exist, prisma migrate dev will create it.

    Note: User needs PostgreSQL running locally. If not available, the migration can be created with --create-only flag.
  </action>
  <verify>
    - prisma/migrations/ contains migration folder
    - `npx prisma generate` succeeds
    - `npx tsc --noEmit` passes (Prisma types available)
  </verify>
  <done>Prisma client generated, initial migration created, types available in TypeScript</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx prisma validate` passes
- [ ] `npx prisma generate` succeeds
- [ ] All models defined: User, Agent, Session, Call, CreditPack, CreditTransaction, PhoneNumber
- [ ] All enums defined: Role, CallStatus, TransactionType, PhoneStatus
- [ ] Migration exists in prisma/migrations/
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Complete data model for Kametrix defined
- Prisma client generated with full type safety
- Ready for authentication implementation in Plan 01-03
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
