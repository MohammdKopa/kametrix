---
phase: 19-prompt-consolidation
plan: 01
type: execute
---

<objective>
Consolidate all system prompt building into a single source of truth module.

Purpose: Eliminate THREE duplicate buildSystemPrompt functions and scattered tool definitions. Create one authoritative location for all prompt logic.
Output: New `src/lib/prompts/` module, all consumers updated to import from it.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-prompt-consolidation/19-RESEARCH.md
@.planning/phases/19-prompt-consolidation/19-CONTEXT.md

**Current duplication:**
1. `src/lib/vapi/assistants.ts` - buildSystemPrompt() for Vapi assistant creation
2. `src/app/api/agents/route.ts` - buildSystemPrompt() for wizard-based creation (DUPLICATE)
3. `src/app/api/webhooks/vapi/route.ts` - Inline dateHeader for assistant-request webhook

Tool definitions also duplicated in assistants.ts (lines 79-150) and webhook route (lines 569-605).

**Research findings:**
- Use section-based prompt structure ([Identity], [Style], [Task])
- Vapi dynamic variables `{{"now" | date: ...}}` for real-time dates
- Voice-optimized: short sentences, no markdown, max 2-3 sentences per response
- German Sie-form required throughout

@src/lib/vapi/assistants.ts
@src/app/api/agents/route.ts
@src/app/api/webhooks/vapi/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create consolidated prompts module</name>
  <files>src/lib/prompts/index.ts, src/lib/prompts/system-prompt.ts, src/lib/prompts/tool-definitions.ts, src/lib/prompts/types.ts</files>
  <action>
Create new `src/lib/prompts/` directory with:

1. **types.ts** - PromptConfig interface:
```typescript
export interface PromptConfig {
  businessName: string;
  businessDescription?: string;
  businessHours: string;
  services: string[];
  faqs: { question: string; answer: string }[];
  policies?: string;
  hasGoogleCalendar: boolean;
}
```

2. **system-prompt.ts** - Single buildSystemPrompt function that:
- Uses section-based structure: [AKTUELLES DATUM...], [Identity], [Geschäftsinformationen], [Häufige Fragen], [Kalender-Funktionen], [Style]
- Includes Vapi dynamic variables `{{"now" | date: ...}}` for calendar-enabled agents
- Voice-optimized: "Halten Sie Antworten kurz (max 2-3 Sätze)", "Keine Markdown-Formatierung verwenden"
- Enforces Sie-form: "Sprechen Sie Anrufer IMMER mit 'Sie' an (formell)"
- Builds dateHeader only when hasGoogleCalendar=true
- Conditional FAQ section when faqs.length > 0
- Conditional calendar section when hasGoogleCalendar=true
- Export helper `buildDateHeader()` for webhook augmentation (when stored prompt lacks Vapi vars)

3. **tool-definitions.ts** - Calendar tool definitions:
- Export `CALENDAR_TOOLS` array with check_availability and book_appointment
- Function `buildCalendarTools(serverUrl: string)` that returns tool array with server URL injected
- German descriptions matching current working pattern
- Allow relative date terms (morgen, heute, Montag) per current webhook implementation

4. **index.ts** - Re-exports all public API:
```typescript
export { buildSystemPrompt, buildDateHeader } from './system-prompt';
export { buildCalendarTools, CALENDAR_TOOL_NAMES } from './tool-definitions';
export type { PromptConfig } from './types';
```
  </action>
  <verify>
- `ls src/lib/prompts/` shows 4 files
- `npx tsc --noEmit` passes (no type errors)
  </verify>
  <done>
- src/lib/prompts/ directory exists with index.ts, system-prompt.ts, tool-definitions.ts, types.ts
- All exports compile without errors
- buildSystemPrompt function implements section-based structure
- buildCalendarTools function returns properly typed tool array
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all consumers to use consolidated module</name>
  <files>src/lib/vapi/assistants.ts, src/app/api/agents/route.ts, src/app/api/webhooks/vapi/route.ts, src/app/api/agents/[id]/refresh/route.ts</files>
  <action>
Update each file to import from `@/lib/prompts`:

1. **src/lib/vapi/assistants.ts:**
- Remove local buildSystemPrompt function (lines 11-58)
- Import: `import { buildSystemPrompt, buildCalendarTools } from '@/lib/prompts';`
- Replace inline tools array with `buildCalendarTools(serverUrl)` call
- Keep createBusinessAssistant, updateAssistant, deleteAssistant, refreshAssistantDate logic unchanged

2. **src/app/api/agents/route.ts:**
- Remove local buildSystemPrompt function (lines 227-299)
- Import: `import { buildSystemPrompt } from '@/lib/prompts';`
- The POST handler already calls buildSystemPrompt with correct shape - just update import

3. **src/app/api/webhooks/vapi/route.ts:**
- Import: `import { buildDateHeader, buildCalendarTools } from '@/lib/prompts';`
- Replace inline dateHeader (lines 545-557) with `buildDateHeader()` call
- Replace inline tools array (lines 569-605) with `buildCalendarTools(serverUrl)` call
- Keep hasVapiVariables check logic (only augment if stored prompt lacks Vapi vars)

4. **src/app/api/agents/[id]/refresh/route.ts:**
- Check if this imports from assistants.ts or builds its own - update imports as needed
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `grep -r "function buildSystemPrompt" src/` returns ONLY src/lib/prompts/system-prompt.ts
- `grep -r "buildDateHeader\|buildCalendarTools" src/app/` shows imports from @/lib/prompts
  </verify>
  <done>
- No duplicate buildSystemPrompt functions remain
- assistants.ts imports from @/lib/prompts
- agents/route.ts imports from @/lib/prompts
- webhooks/vapi/route.ts imports buildDateHeader and buildCalendarTools from @/lib/prompts
- All TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify build and test prompt output</name>
  <files>N/A - verification only</files>
  <action>
Run full build to verify:
1. `npm run build` - must complete without errors
2. Manual verification: Review the consolidated buildSystemPrompt output structure matches RESEARCH.md recommendations:
   - Section headers in correct order
   - Voice-optimized instructions present
   - Sie-form enforcement present
   - No markdown formatting instruction present
  </action>
  <verify>
- `npm run build` succeeds
- Build output shows no warnings related to prompts module
  </verify>
  <done>
- Build completes successfully
- No type errors, no lint warnings
- Prompt consolidation complete
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] Single buildSystemPrompt function exists (only in src/lib/prompts/)
- [ ] All 3 original locations import from @/lib/prompts
- [ ] No inline tool definitions remain outside of src/lib/prompts/
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No duplicate prompt building code remains
- Single source of truth established at src/lib/prompts/
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-prompt-consolidation/19-01-SUMMARY.md`:

# Phase 19 Plan 01: Prompt Consolidation Summary

**[One-liner describing what was accomplished]**

## Accomplishments
- Created src/lib/prompts/ module with single buildSystemPrompt function
- Consolidated tool definitions into buildCalendarTools function
- Updated all consumers to import from new module
- Eliminated 3 duplicate buildSystemPrompt functions

## Files Created/Modified
- `src/lib/prompts/index.ts` - Module re-exports
- `src/lib/prompts/system-prompt.ts` - Consolidated buildSystemPrompt
- `src/lib/prompts/tool-definitions.ts` - Consolidated tool definitions
- `src/lib/prompts/types.ts` - PromptConfig interface
- `src/lib/vapi/assistants.ts` - Updated imports
- `src/app/api/agents/route.ts` - Updated imports
- `src/app/api/webhooks/vapi/route.ts` - Updated imports

## Decisions Made
[Any decisions made during implementation]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Phase complete, ready for Phase 20: Switch to ElevenLabs
</output>
