---
phase: 05-payments-credits
plan: 01
type: execute
---

<objective>
Set up Stripe SDK, webhook endpoint, and credit pack products.

Purpose: Establish the payment infrastructure for credit purchases.
Output: Working Stripe webhook, User model with stripeCustomerId, seeded CreditPack records with Stripe Price IDs.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-payments-credits/05-RESEARCH.md
@.planning/phases/05-payments-credits/05-CONTEXT.md

**Prior decisions affecting this phase:**
- Phase 0: Stripe for payments (PROJECT.md constraint)
- Phase 0: Credit packs model (simple one-time purchases, no subscriptions)
- Phase 1: Prisma schema already has CreditPack, CreditTransaction, User.creditBalance

**Codebase context:**
- CreditPack model exists but needs stripePriceId values
- User model needs stripeCustomerId field for Stripe Customer linking
- Webhook endpoint pattern exists at /api/webhooks/vapi - follow same style

**Credit pack products to create:**
Per CONTEXT.md: 3-4 pack options displayed as card grid
Suggested packs (based on $0.15/minute pricing):
- Starter: $10 (1000 cents = ~66 minutes)
- Popular: $25 (2500 cents = ~166 minutes)
- Pro: $50 (5000 cents = ~333 minutes)
- Business: $100 (10000 cents = ~666 minutes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Stripe SDK and add stripeCustomerId to User model</name>
  <files>package.json, prisma/schema.prisma, src/lib/stripe.ts</files>
  <action>
1. Install Stripe SDK: `npm install stripe`
2. Add to User model in prisma/schema.prisma:
   ```
   stripeCustomerId  String?   @unique // Stripe customer ID
   ```
3. Run `npx prisma migrate dev --name add_stripe_customer_id`
4. Create src/lib/stripe.ts with singleton Stripe client:
   - Use globalThis pattern (same as prisma.ts)
   - Initialize with STRIPE_SECRET_KEY from env
   - Export stripe instance

WHY: Stripe Customer linking ensures payment history is tied to user. Singleton prevents multiple client instances.
  </action>
  <verify>
- npm list stripe shows package installed
- npx prisma validate passes
- src/lib/stripe.ts exports stripe client
  </verify>
  <done>Stripe SDK installed, User model has stripeCustomerId, stripe.ts client ready</done>
</task>

<task type="auto">
  <name>Task 2: Create Stripe webhook endpoint with signature verification</name>
  <files>src/app/api/webhooks/stripe/route.ts</files>
  <action>
Create webhook handler following the pattern from 05-RESEARCH.md:

1. Create src/app/api/webhooks/stripe/route.ts
2. Export async POST handler that:
   - Uses `await request.text()` (NOT .json() - critical for signature verification)
   - Gets stripe-signature header
   - Calls stripe.webhooks.constructEvent() with STRIPE_WEBHOOK_SECRET
   - Handles checkout.session.completed event
   - Returns 200 OK on success, 400 on signature failure

3. For checkout.session.completed:
   - Extract userId and creditsAmount from session.metadata
   - Call handleSuccessfulPayment() (implement in same file for now)
   - handleSuccessfulPayment should use prisma.$transaction to:
     a. Get current user balance
     b. Calculate new balance (handle grace credits settlement)
     c. Update user creditBalance and graceCreditsUsed
     d. Create CreditTransaction record with type PURCHASE

CRITICAL: Use request.text() not request.json() - signature verification requires raw body.
  </action>
  <verify>
- File exists at src/app/api/webhooks/stripe/route.ts
- npm run build passes (no TypeScript errors)
  </verify>
  <done>Stripe webhook endpoint handles checkout.session.completed with signature verification and atomic credit addition</done>
</task>

<task type="auto">
  <name>Task 3: Seed CreditPack records with Stripe products</name>
  <files>prisma/seed.ts, package.json</files>
  <action>
Create seed script to populate CreditPack table:

1. Create prisma/seed.ts (or update if exists):
   - Import prisma client
   - Import stripe client from @/lib/stripe
   - Check if STRIPE_SECRET_KEY exists (skip Stripe creation if not - allows local dev)

2. Define credit packs:
   ```typescript
   const packs = [
     { name: 'Starter', credits: 1000, priceInCents: 1000 },   // $10 ~66 min
     { name: 'Popular', credits: 2500, priceInCents: 2500 },   // $25 ~166 min
     { name: 'Pro', credits: 5000, priceInCents: 5000 },       // $50 ~333 min
     { name: 'Business', credits: 10000, priceInCents: 10000 }, // $100 ~666 min
   ];
   ```

3. For each pack:
   - Check if CreditPack with that name exists (skip if so - idempotent)
   - If STRIPE_SECRET_KEY set:
     a. Create Stripe Product
     b. Create Stripe Price
     c. Use price.id as stripePriceId
   - Create CreditPack record in DB

4. Add to package.json scripts:
   ```json
   "db:seed": "tsx prisma/seed.ts"
   ```

5. Update prisma/schema.prisma to configure seed command if not already set

WHY: Seed script is idempotent - safe to run multiple times. Stripe products only created in environments with keys.
  </action>
  <verify>
- npm run db:seed completes without errors
- Check CreditPack table has 4 records
  </verify>
  <done>CreditPack table seeded with 4 packs, Stripe products created if keys present</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx prisma validate` passes
- [ ] Stripe SDK installed and stripe.ts exports client
- [ ] User model has stripeCustomerId field
- [ ] Webhook endpoint at /api/webhooks/stripe exists
- [ ] CreditPack table has 4 seeded records
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Stripe infrastructure ready for credit purchases
</success_criteria>

<output>
After completion, create `.planning/phases/05-payments-credits/05-01-SUMMARY.md`
</output>
