---
phase: 05-payments-credits
plan: 04
type: execute
---

<objective>
Implement grace period visibility and low balance warnings.

Purpose: Keep users informed about their credit status with transparent warnings.
Output: Low balance warning banner, grace period banner on credits page, balance display updates across dashboard.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-payments-credits/05-RESEARCH.md
@.planning/phases/05-payments-credits/05-CONTEXT.md
@.planning/phases/05-payments-credits/05-01-SUMMARY.md
@.planning/phases/05-payments-credits/05-02-SUMMARY.md
@.planning/phases/05-payments-credits/05-03-SUMMARY.md

**UI requirements from CONTEXT.md:**
- Fixed threshold for low balance warning ($5 or ~33 minutes)
- Grace period: soft warning only, never interrupt service
- Balance displayed as "$X.XX (~Y min)" everywhere
- Grace usage banner: "You have $X.XX in grace credits that will be settled on your next purchase"

**Key constraint from CONTEXT.md:**
- "No hard cutoffs" - Calls never stop, grace period is soft warning only
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add low balance check utilities and constants</name>
  <files>src/lib/credits.ts</files>
  <action>
Add to src/lib/credits.ts:

1. Define threshold constants:
   ```typescript
   export const LOW_BALANCE_THRESHOLD_CENTS = 500; // $5.00
   export const LOW_BALANCE_THRESHOLD_MINUTES = 33; // ~$5 at $0.15/min
   ```

2. Create check function:
   ```typescript
   export function isLowBalance(creditBalanceCents: number): boolean {
     return creditBalanceCents <= LOW_BALANCE_THRESHOLD_CENTS;
   }

   export function hasGraceUsage(graceCreditsUsed: number): boolean {
     return graceCreditsUsed > 0;
   }
   ```

3. Create warning message generators:
   ```typescript
   export function getLowBalanceMessage(balanceCents: number): string {
     const estimatedMinutes = Math.floor(balanceCents / CENTS_PER_MINUTE);
     return `Low balance: ${formatBalance(balanceCents)}. You have about ${estimatedMinutes} minutes of call time remaining.`;
   }

   export function getGraceUsageMessage(graceUsedCents: number): string {
     const dollars = (graceUsedCents / 100).toFixed(2);
     return `You have $${dollars} in grace credits that will be settled on your next purchase.`;
   }
   ```
  </action>
  <verify>
- npm run build passes
- New functions exported from credits.ts
  </verify>
  <done>Low balance and grace period utilities added</done>
</task>

<task type="auto">
  <name>Task 2: Update dashboard to show low balance warning</name>
  <files>src/app/(dashboard)/dashboard/page.tsx, src/components/dashboard/stats-card.tsx</files>
  <action>
Update the main dashboard page:

1. Import isLowBalance, hasGraceUsage, formatBalance from @/lib/credits

2. Update the Credit Balance stats card:
   - Show balance in "$X.XX (~Y min)" format instead of raw cents
   - Add warning indicator if isLowBalance(user.creditBalance)

3. Add warning banner below stats if low balance OR grace usage:
   ```tsx
   {(isLowBalance(user.creditBalance) || hasGraceUsage(user.graceCreditsUsed)) && (
     <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
       <div className="flex items-start gap-3">
         <ExclamationTriangleIcon className="h-5 w-5 text-amber-500 mt-0.5" />
         <div>
           {isLowBalance(user.creditBalance) && (
             <p className="text-amber-800 text-sm">
               {getLowBalanceMessage(user.creditBalance)}
             </p>
           )}
           {hasGraceUsage(user.graceCreditsUsed) && (
             <p className="text-amber-800 text-sm mt-1">
               {getGraceUsageMessage(user.graceCreditsUsed)}
             </p>
           )}
           <a href="/dashboard/credits" className="text-amber-700 text-sm font-medium hover:underline mt-2 inline-block">
             Buy more credits â†’
           </a>
         </div>
       </div>
     </div>
   )}
   ```

4. Ensure StatsCard can handle formatted strings (not just numbers).
  </action>
  <verify>
- npm run build passes
- Dashboard shows warning banner when balance is low
  </verify>
  <done>Dashboard displays low balance and grace usage warnings</done>
</task>

<task type="auto">
  <name>Task 3: Update credits page with grace period banner</name>
  <files>src/app/(dashboard)/dashboard/credits/page.tsx</files>
  <action>
Enhance the credits page:

1. If user.graceCreditsUsed > 0, show prominent banner at top:
   ```tsx
   {user.graceCreditsUsed > 0 && (
     <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
       <div className="flex items-center gap-3">
         <ExclamationTriangleIcon className="h-5 w-5 text-amber-500" />
         <div>
           <p className="text-amber-800 font-medium">Grace Period Active</p>
           <p className="text-amber-700 text-sm">
             You have ${(user.graceCreditsUsed / 100).toFixed(2)} in grace credits
             that will be automatically settled on your next purchase.
           </p>
         </div>
       </div>
     </div>
   )}
   ```

2. Show settlement preview on pack cards when grace is active:
   - Add small text: "After $X.XX grace settlement, you'll receive Y credits"
   - Calculate: effectiveCredits = pack.credits - graceCreditsUsed (if positive)
   - Only show if pack price covers grace amount

3. Update balance display at top to use formatBalance() from credits.ts
  </action>
  <verify>
- npm run build passes
- Grace period banner shows when graceCreditsUsed > 0
- Pack cards show settlement preview when grace is active
  </verify>
  <done>Credits page shows grace period status and settlement preview</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Low balance warnings and grace period visibility across dashboard</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Manually set a user's creditBalance to 300 (cents) in database or use admin panel
    3. Visit: http://localhost:3000/dashboard
    4. Verify: Low balance warning banner appears with message about ~20 min remaining
    5. Verify: Credit Balance card shows "$3.00 (~20 min)" format
    6. Verify: Warning has link to buy credits
    7. Set graceCreditsUsed to 150 in database
    8. Refresh dashboard
    9. Verify: Additional grace usage message appears
    10. Visit: http://localhost:3000/dashboard/credits
    11. Verify: Grace period banner at top
    12. Verify: Pack cards show settlement preview
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Dashboard shows low balance warning when balance <= $5
- [ ] Dashboard shows grace usage warning when graceCreditsUsed > 0
- [ ] Credits page shows grace period banner when active
- [ ] Balance displayed as "$X.XX (~Y min)" format everywhere
- [ ] Pack cards show settlement preview when grace is active
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Users have full visibility into their credit status
- Phase 5 complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-payments-credits/05-04-SUMMARY.md`

This is the final plan for Phase 5. After this plan completes, update:
- ROADMAP.md: Mark Phase 5 as complete
- STATE.md: Update current position to Phase 6
</output>
