---
phase: 05-payments-credits
plan: 02
type: execute
---

<objective>
Build the credit purchase flow with Stripe Checkout.

Purpose: Enable users to buy credit packs through a clean UI and Stripe-hosted checkout.
Output: Credits page with pack cards, checkout API route, and success handling.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-payments-credits/05-RESEARCH.md
@.planning/phases/05-payments-credits/05-CONTEXT.md
@.planning/phases/05-payments-credits/05-01-SUMMARY.md

**Prior context from 05-01:**
- Stripe SDK installed at src/lib/stripe.ts
- User model has stripeCustomerId
- CreditPack table seeded with 4 packs
- Webhook at /api/webhooks/stripe handles checkout.session.completed

**UI requirements from CONTEXT.md:**
- Credit packs displayed as card grid (3-4 options)
- Balance format: "$12.50 (~45 min)" everywhere
- Frictionless: pick a pack, click buy, Stripe Checkout, done
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create credits page with pack cards</name>
  <files>src/app/(dashboard)/dashboard/credits/page.tsx, src/components/dashboard/credit-pack-card.tsx</files>
  <action>
1. Create CreditPackCard component (src/components/dashboard/credit-pack-card.tsx):
   - Props: id, name, credits, priceInCents, isPopular (for highlight)
   - Display: Pack name, price as "$X.XX", estimated minutes (~credits/15 min)
   - "Buy" button that POSTs to /api/checkout with packId
   - Popular pack gets highlighted border/badge

2. Create credits page (src/app/(dashboard)/dashboard/credits/page.tsx):
   - Server component that fetches user and credit packs
   - Display current balance with format helper: "$X.XX (~Y min)"
   - Grid of CreditPackCard components (responsive: 1 col mobile, 2 col tablet, 4 col desktop)
   - If graceCreditsUsed > 0, show banner: "You have $X.XX in grace credits that will be settled on your next purchase"

3. Add balance format helper function:
   ```typescript
   function formatBalance(cents: number): string {
     const dollars = (cents / 100).toFixed(2);
     const minutes = Math.floor(cents / 15); // $0.15/min
     return `$${dollars} (~${minutes} min)`;
   }
   ```

Style: Follow existing dashboard patterns. Use Tailwind classes consistent with other pages.
  </action>
  <verify>
- npm run build passes
- Navigate to /dashboard/credits shows page with 4 pack cards
  </verify>
  <done>Credits page displays balance and 4 purchasable pack cards</done>
</task>

<task type="auto">
  <name>Task 2: Create checkout API route with Stripe Checkout Session</name>
  <files>src/app/api/checkout/route.ts</files>
  <action>
Create POST /api/checkout endpoint:

1. Authenticate user with requireAuth()
2. Get packId from request body
3. Fetch CreditPack from database, verify it exists and is active
4. Ensure user has Stripe customer:
   - If user.stripeCustomerId is null, create Stripe customer with user.email
   - Update user with stripeCustomerId
5. Create Checkout Session:
   ```typescript
   const session = await stripe.checkout.sessions.create({
     customer: stripeCustomerId,
     mode: 'payment',
     line_items: [{
       price: creditPack.stripePriceId,
       quantity: 1
     }],
     success_url: `${process.env.NEXT_PUBLIC_APP_URL}/dashboard/credits?success=true`,
     cancel_url: `${process.env.NEXT_PUBLIC_APP_URL}/dashboard/credits`,
     metadata: {
       userId: user.id,
       creditPackId: creditPack.id,
       creditsAmount: creditPack.credits.toString()
     }
   });
   ```
6. Return session.url for client redirect

CRITICAL: Include userId and creditsAmount in metadata - webhook uses these to credit the user.
  </action>
  <verify>
- npm run build passes
- POST /api/checkout with valid packId returns session URL
  </verify>
  <done>Checkout endpoint creates Stripe session with correct metadata</done>
</task>

<task type="auto">
  <name>Task 3: Handle purchase success in credits page</name>
  <files>src/app/(dashboard)/dashboard/credits/page.tsx</files>
  <action>
Update credits page to handle success/cancel states:

1. Accept searchParams: success, canceled
2. On success=true:
   - Show success notification banner: "Credits added successfully!"
   - Use DashboardNotification component (already exists from Phase 4)
3. On canceled=true:
   - Show info notification: "Purchase canceled"

4. Update CreditPackCard buy button:
   - On click, POST to /api/checkout with packId
   - On success response, redirect to session.url (window.location.href = url)
   - Show loading state during redirect

The webhook handler (from 05-01) will add credits - by the time user returns to success URL, credits should be there.
  </action>
  <verify>
- npm run build passes
- Credits page shows success message when ?success=true
  </verify>
  <done>Credits page handles success/cancel states with notifications</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Credit purchase flow: credits page with pack cards and Stripe Checkout integration</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000/dashboard/credits
    3. Verify: Page shows current balance in "$X.XX (~Y min)" format
    4. Verify: 4 credit pack cards displayed in grid
    5. Click "Buy" on any pack
    6. Verify: Redirects to Stripe Checkout (test mode)
    7. In Stripe: Use test card 4242424242424242, any future date, any CVC
    8. Complete payment
    9. Verify: Redirects back to /dashboard/credits?success=true
    10. Verify: Success notification shows
    11. Verify: Balance increased (may need to refresh if webhook is slow)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Credits page at /dashboard/credits displays correctly
- [ ] Balance shown in "$X.XX (~Y min)" format
- [ ] 4 pack cards render in responsive grid
- [ ] Checkout redirects to Stripe
- [ ] Success page shows notification
- [ ] `npm run build` succeeds without errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Users can purchase credit packs via Stripe Checkout
</success_criteria>

<output>
After completion, create `.planning/phases/05-payments-credits/05-02-SUMMARY.md`
</output>
