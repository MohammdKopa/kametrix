---
phase: 14-critical-bug-fixes
plan: 01
type: execute
---

<objective>
Fix the appointment year bug where bookings are created with year 2023 instead of the correct year.

Purpose: Ensure all calendar bookings use the correct year, making the booking system reliable before production use.
Output: Validated date handling that auto-corrects past-year dates to the current year.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-critical-bug-fixes/14-CONTEXT.md

**Problem Analysis:**

The LLM (Vapi's AI assistant) sometimes generates dates with incorrect years (e.g., 2023 instead of 2025). This happens because:
1. LLMs can hallucinate dates despite explicit instructions
2. The system currently trusts `args.date` from the AI without validation
3. There's a date header injected but it's not foolproof

**Root Cause Location:**
- `src/app/api/webhooks/vapi/route.ts` lines 379 and 419 - dates from AI are used directly
- `src/lib/google/calendar.ts` parseDateTime() - trusts the dateStr input

**Fix Strategy:**
Add a `validateAndCorrectDate()` utility that:
1. Validates the incoming date format (YYYY-MM-DD)
2. Detects if the year is in the past
3. Auto-corrects past years to the current year
4. Logs when corrections are made (for debugging)

Relevant source files:
@src/lib/google/calendar.ts
@src/app/api/webhooks/vapi/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add date validation and correction utility</name>
  <files>src/lib/google/calendar.ts</files>
  <action>
Add a new exported function `validateAndCorrectDate()` that:

1. Takes a date string (expected YYYY-MM-DD format)
2. Parses the year, month, and day
3. If year is in the past (< current year), replace with current year
4. If year is more than 1 year in the future, log a warning but allow it (could be legitimate)
5. Returns the corrected date string in YYYY-MM-DD format
6. Logs when a correction is made: `console.warn('Date year corrected from XXXX to YYYY')`

Add this function near the top of the file (after imports, before getAvailableSlots).

Example implementation:
```typescript
export function validateAndCorrectDate(dateStr: string): string {
  const currentYear = new Date().getFullYear();

  // Parse the date string
  const match = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!match) {
    console.warn(`Invalid date format: ${dateStr}, expected YYYY-MM-DD`);
    return dateStr; // Return as-is, let downstream handle the error
  }

  const [, yearStr, month, day] = match;
  const year = parseInt(yearStr, 10);

  // Correct past years to current year
  if (year < currentYear) {
    console.warn(`Date year corrected from ${year} to ${currentYear}: ${dateStr}`);
    return `${currentYear}-${month}-${day}`;
  }

  // Warn about far future dates but allow them
  if (year > currentYear + 1) {
    console.warn(`Date is more than a year in the future: ${dateStr}`);
  }

  return dateStr;
}
```
  </action>
  <verify>TypeScript compilation passes: npx tsc --noEmit</verify>
  <done>validateAndCorrectDate function exists and compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: Integrate date correction in Vapi webhook handler</name>
  <files>src/app/api/webhooks/vapi/route.ts</files>
  <action>
1. Import validateAndCorrectDate from '@/lib/google/calendar'

2. In the check_availability case (around line 379):
   - Before: `const date = new Date(args.date);`
   - After: `const correctedDateStr = validateAndCorrectDate(args.date); const date = new Date(correctedDateStr);`

3. In the book_appointment case (around line 419):
   - Before: `const start = parseDateTime(args.date, args.time, timeZone);`
   - After: `const correctedDateStr = validateAndCorrectDate(args.date); const start = parseDateTime(correctedDateStr, args.time, timeZone);`

4. Also update line 442 where bookingDate is created:
   - Before: `const bookingDate = new Date(args.date);`
   - After: `const bookingDate = new Date(correctedDateStr);` (reuse the corrected value)

This ensures ALL date handling in the booking flow uses the corrected date.
  </action>
  <verify>TypeScript compilation passes: npx tsc --noEmit</verify>
  <done>Both check_availability and book_appointment use validateAndCorrectDate before processing dates</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for date validation</name>
  <files>src/lib/google/__tests__/calendar.test.ts</files>
  <action>
Create a new test file for the calendar utilities. Test validateAndCorrectDate with:

1. Valid current year date - should return unchanged
2. Valid future year date (next year) - should return unchanged
3. Past year date (2023) - should correct to current year
4. Past year date (2024 if current is 2025) - should correct to current year
5. Invalid format - should return unchanged (logs warning)
6. Far future date (2027+) - should return unchanged (logs warning)

Use vitest (project uses vitest based on typical Next.js setup). If vitest is not set up, use Node's built-in test runner or check package.json for test framework.

Example test structure:
```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { validateAndCorrectDate } from '../calendar';

describe('validateAndCorrectDate', () => {
  const originalConsoleWarn = console.warn;

  beforeEach(() => {
    console.warn = vi.fn();
  });

  afterEach(() => {
    console.warn = originalConsoleWarn;
  });

  it('returns unchanged for current year dates', () => {
    const currentYear = new Date().getFullYear();
    const date = `${currentYear}-06-15`;
    expect(validateAndCorrectDate(date)).toBe(date);
    expect(console.warn).not.toHaveBeenCalled();
  });

  it('corrects past year to current year', () => {
    const currentYear = new Date().getFullYear();
    const pastDate = '2023-06-15';
    expect(validateAndCorrectDate(pastDate)).toBe(`${currentYear}-06-15`);
    expect(console.warn).toHaveBeenCalled();
  });

  it('returns unchanged for invalid format', () => {
    const invalid = 'not-a-date';
    expect(validateAndCorrectDate(invalid)).toBe(invalid);
    expect(console.warn).toHaveBeenCalled();
  });
});
```
  </action>
  <verify>Tests pass: npm test or npx vitest run src/lib/google/__tests__/calendar.test.ts</verify>
  <done>Unit tests exist and pass for validateAndCorrectDate function</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes without errors
- [ ] Unit tests pass for validateAndCorrectDate
- [ ] Manual verification: dates with year 2023 get corrected to current year (check console logs)
</verification>

<success_criteria>
- validateAndCorrectDate function exists and is exported
- Both check_availability and book_appointment use the validation function
- Unit tests cover the main scenarios (past year correction, valid dates, invalid format)
- No TypeScript errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/14-critical-bug-fixes/14-01-SUMMARY.md`
</output>
