---
phase: 20-switch-to-elevenlabs
plan: 2
type: execute
---

<objective>
Update wizard and agent form UI to use ElevenLabs voices with preview capability.

Purpose: Let users preview and select from curated German ElevenLabs voices in the wizard.
Output: Voice step with play buttons, agent form with ElevenLabs voices, working audio preview.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-switch-to-elevenlabs/20-RESEARCH.md
@.planning/phases/20-switch-to-elevenlabs/20-CONTEXT.md
@.planning/phases/20-switch-to-elevenlabs/20-01-SUMMARY.md

**Prior plan context:**
- Voice constants created in src/lib/constants/voices.ts
- Voice preview API at POST /api/voice-preview
- Types updated to support '11labs' provider

@src/components/wizard/steps/voice-step.tsx
@src/components/dashboard/agent-form.tsx
@src/lib/constants/voices.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useVoicePreview hook</name>
  <files>src/hooks/useVoicePreview.ts</files>
  <action>
Create hook that:
1. Manages state: isPlaying (string | null for voiceId), isLoading (string | null for voiceId)
2. Uses useRef for HTMLAudioElement to prevent memory leaks
3. playPreview(voiceId) function:
   - Stop any currently playing audio (pause + null ref)
   - Set isLoading to voiceId
   - Fetch POST /api/voice-preview with { voiceId }
   - Convert response to blob, create object URL
   - Create new Audio, set to audioRef
   - Set up onplay (setIsPlaying), onended (cleanup + setIsPlaying null), onerror handlers
   - Call audio.play()
   - Clear isLoading in finally block
4. stopPreview() function:
   - Pause audio, null ref, clear isPlaying
5. Return { playPreview, stopPreview, isPlaying, isLoading }

Use useCallback for functions. Revoke object URL on audio ended to prevent memory leaks.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>useVoicePreview hook exports playPreview, stopPreview, isPlaying, isLoading</done>
</task>

<task type="auto">
  <name>Task 2: Update wizard voice-step with ElevenLabs voices and preview</name>
  <files>src/components/wizard/steps/voice-step.tsx</files>
  <action>
Redesign voice-step.tsx:

1. Import ELEVENLABS_VOICES from @/lib/constants/voices
2. Import useVoicePreview hook
3. Remove the VOICE_PROVIDERS array with Azure voices

4. Update UI structure:
   - Remove provider selection (only ElevenLabs now)
   - Show voice grid with 4 ElevenLabs voices
   - Each voice card shows: name, description (German), play/stop button, selection radio

5. Voice card design (match existing glassmorphic theme):
   - Selected state: border-primary, bg-primary/10
   - Unselected: border-border, hover:border-primary/50
   - Play button: circular, shows Play icon normally, Loader2 when loading, Square (stop) when playing
   - Use Lucide icons: Play, Square, Loader2

6. Fix onChange to only update voiceId (provider always '11labs' now):
   ```typescript
   onChange({ voiceId: voice.id, voiceProvider: '11labs' });
   ```

7. Remove the "preview coming soon" note - we now have preview!

8. Add small helper text below voice grid: "Klicken Sie auf ▶ um eine Vorschau zu hören"
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`, visual check in browser</verify>
  <done>Voice step shows 4 ElevenLabs voices with working preview buttons</done>
</task>

<task type="auto">
  <name>Task 3: Update agent-form with ElevenLabs voices</name>
  <files>src/components/dashboard/agent-form.tsx</files>
  <action>
1. Import ELEVENLABS_VOICES from @/lib/constants/voices
2. Replace VOICE_OPTIONS array with ELEVENLABS_VOICES.map to create options:
   ```typescript
   const VOICE_OPTIONS = ELEVENLABS_VOICES.map(v => ({
     id: v.id,
     name: `${v.name} (${v.gender === 'female' ? 'Weiblich' : 'Männlich'})`,
   }));
   ```
3. Update default voiceId in formData useState:
   - Change from 'de-DE-KatjaNeural' to ELEVENLABS_VOICES[0].id (Sarah)

No preview buttons needed in agent-form - it's for editing, not initial selection.
Keep the simple dropdown, just with new voice options.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Agent form dropdown shows ElevenLabs voices, defaults to Sarah</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] useVoicePreview hook exists with correct exports
- [ ] Voice step shows 4 ElevenLabs voices with preview buttons
- [ ] Clicking preview button plays German audio sample
- [ ] Agent form dropdown shows ElevenLabs voices
</verification>

<success_criteria>
- All tasks completed
- Build passes without errors
- Voice preview plays German audio for each voice
- UI matches existing glassmorphic theme
- Phase 20 complete - ElevenLabs is the default voice provider
</success_criteria>

<output>
After completion, create `.planning/phases/20-switch-to-elevenlabs/20-02-SUMMARY.md`:

# Phase 20 Plan 2: UI with Voice Preview Summary

**[One-liner summary]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions or "None"]

## Issues Encountered
[Problems and resolutions or "None"]

## Next Step
Phase 20 complete, ready for Phase 21 (Wizard Polish)
</output>
