---
phase: 20-switch-to-elevenlabs
plan: 1
type: execute
---

<objective>
Set up ElevenLabs backend infrastructure: voice constants, Vapi config update, and preview API.

Purpose: Enable ElevenLabs as the voice provider for all new agents with German voice support.
Output: Voice constants file, updated assistants.ts with ElevenLabs config, working voice preview API endpoint.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-switch-to-elevenlabs/20-RESEARCH.md
@.planning/phases/20-switch-to-elevenlabs/20-CONTEXT.md

**Key Research Findings:**
- Vapi ElevenLabs config: `{ provider: '11labs', voiceId: '...', model: 'eleven_turbo_v2_5', language: 'de' }`
- Curated German voices: Sarah, Matilda, Adam, Antoni (IDs in RESEARCH.md)
- Preview via POST to `https://api.elevenlabs.io/v1/text-to-speech/{voice_id}/stream`
- Must hide API key server-side

@src/lib/vapi/assistants.ts
@src/types/wizard.ts
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create voice constants and update types</name>
  <files>src/lib/constants/voices.ts, src/types/wizard.ts, .env.example</files>
  <action>
1. Create `src/lib/constants/voices.ts` with ELEVENLABS_VOICES array:
   - Sarah (EXAVITQu4vr4xnSDxMaL) - Sanft und professionell
   - Matilda (XrExE9yKIg1WjnnlVkGX) - Warm und freundlich
   - Adam (pNInz6obpgDQGcFmaJgB) - Professionell und vertrauensw√ºrdig
   - Antoni (ErXwobaYiN019PkySvjV) - Freundlich und nahbar
   - Export DEFAULT_ELEVENLABS_VOICE = Sarah's ID
   - Include name, id, description (German), gender for each

2. Update `src/types/wizard.ts`:
   - Change voiceProvider type from `'azure'` to `'azure' | '11labs'`
   - Update DEFAULT_WIZARD_STATE to use '11labs' provider and Sarah's voice ID

3. Add to `.env.example`:
   ```
   # ElevenLabs (for voice previews)
   ELEVENLABS_API_KEY=your_elevenlabs_api_key_here
   ```
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>Voice constants exported, wizard types support '11labs', env example updated</done>
</task>

<task type="auto">
  <name>Task 2: Update Vapi assistants to use ElevenLabs</name>
  <files>src/lib/vapi/assistants.ts</files>
  <action>
1. Update `createBusinessAssistant()` voice config:
   ```typescript
   voice: {
     provider: '11labs',
     voiceId: config.voiceId ?? 'EXAVITQu4vr4xnSDxMaL', // Sarah default
     model: 'eleven_turbo_v2_5',
     language: 'de',
   },
   ```

2. Update `updateAssistant()` to also use '11labs' provider when updating voice:
   ```typescript
   if (config.voiceId) {
     updatePayload.voice = {
       provider: '11labs',
       voiceId: config.voiceId,
       model: 'eleven_turbo_v2_5',
       language: 'de',
     };
   }
   ```

Remove Azure references - all new agents use ElevenLabs.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Both createBusinessAssistant and updateAssistant use ElevenLabs voice config</done>
</task>

<task type="auto">
  <name>Task 3: Create voice preview API endpoint</name>
  <files>src/app/api/voice-preview/route.ts</files>
  <action>
Create POST endpoint that:
1. Accepts `{ voiceId: string }` in request body
2. Validates voiceId is provided (return 400 if missing)
3. Calls ElevenLabs TTS API:
   - URL: `https://api.elevenlabs.io/v1/text-to-speech/${voiceId}/stream`
   - Headers: `xi-api-key` from ELEVENLABS_API_KEY env, `Content-Type: application/json`, `Accept: audio/mpeg`
   - Body: German sample text "Guten Tag! Wie kann ich Ihnen heute behilflich sein?", model_id: "eleven_turbo_v2_5", voice_settings: { stability: 0.5, similarity_boost: 0.75 }
4. Return audio buffer with Content-Type: audio/mpeg
5. Add Cache-Control: public, max-age=3600 for 1 hour caching
6. Handle errors gracefully with 500 response

Use NextResponse for the response. Log errors to console.
  </action>
  <verify>API route exists, TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>POST /api/voice-preview returns audio/mpeg when given valid voiceId</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] Voice constants file exports ELEVENLABS_VOICES array with 4 voices
- [ ] DEFAULT_WIZARD_STATE uses '11labs' provider
- [ ] assistants.ts uses '11labs' provider in both create and update functions
- [ ] /api/voice-preview route.ts exists with POST handler
- [ ] .env.example contains ELEVENLABS_API_KEY
</verification>

<success_criteria>
- All tasks completed
- TypeScript compiles without errors
- ElevenLabs is the default voice provider
- Voice preview endpoint ready for UI consumption
</success_criteria>

<output>
After completion, create `.planning/phases/20-switch-to-elevenlabs/20-01-SUMMARY.md`:

# Phase 20 Plan 1: Backend & API Summary

**[One-liner summary]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions or "None"]

## Issues Encountered
[Problems and resolutions or "None"]

## Next Step
Ready for 20-02-PLAN.md (UI with voice preview)
</output>
