---
phase: 17-admin-price-control
plan: 01
type: execute
---

<objective>
Add database-backed pricing settings with admin API endpoints.

Purpose: Enable the per-minute rate to be stored in the database rather than hardcoded, with API endpoints for admin management.
Output: SiteSetting model, migration, and admin API endpoint for pricing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-admin-price-control/17-CONTEXT.md

**Codebase constraints:**
- Prisma 7 with PostgreSQL
- Next.js 15 route handlers for API
- Admin routes require `requireAdmin()` guard from `@/lib/auth-guard.ts`

**Relevant source files:**
@prisma/schema.prisma
@src/lib/credits-utils.ts
@src/app/api/admin/credits/adjust/route.ts (example admin API pattern)
@src/lib/auth-guard.ts

**Current state:**
- `CENTS_PER_MINUTE = 15` hardcoded in `src/lib/credits-utils.ts`
- No settings table exists in database
- Admin API routes use `requireAdmin()` pattern

**From CONTEXT.md:**
- Single global rate (no per-user rates)
- No history/audit log needed
- Immediate effect on save
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SiteSetting model and helper functions</name>
  <files>prisma/schema.prisma, src/lib/settings.ts</files>
  <action>
1. Add SiteSetting model to prisma/schema.prisma:
   ```prisma
   model SiteSetting {
     key       String   @id
     value     String
     updatedAt DateTime @updatedAt
   }
   ```

2. Run migration: `npx prisma migrate dev --name add-site-settings`

3. Create src/lib/settings.ts with:
   - `SETTING_KEYS` const object with `CENTS_PER_MINUTE: 'cents_per_minute'`
   - `DEFAULT_CENTS_PER_MINUTE = 15` constant (fallback if not set)
   - `getCentsPerMinute()` async function that:
     - Queries SiteSetting for key 'cents_per_minute'
     - Returns parsed int value, or DEFAULT_CENTS_PER_MINUTE if not found
     - Caches result for performance (use globalThis pattern like stripe.ts)
   - `setCentsPerMinute(value: number)` async function that:
     - Validates value is positive integer
     - Upserts SiteSetting with key 'cents_per_minute'
     - Clears cache so next read gets fresh value

Use lazy initialization pattern from src/lib/stripe.ts for caching.
  </action>
  <verify>
- `npx prisma validate` passes
- `npx prisma generate` succeeds
- `npm run build` compiles without errors
  </verify>
  <done>
- SiteSetting model exists in schema
- Migration applied successfully
- settings.ts exports getCentsPerMinute and setCentsPerMinute functions
- Functions compile without TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin settings API endpoint</name>
  <files>src/app/api/admin/settings/route.ts</files>
  <action>
Create src/app/api/admin/settings/route.ts with:

**GET handler:**
- Call `requireAdmin()` for authorization
- Fetch current cents_per_minute using `getCentsPerMinute()`
- Return JSON: `{ centsPerMinute: number }`

**PUT handler:**
- Call `requireAdmin()` for authorization
- Parse request body for `centsPerMinute` number
- Validate: must be positive integer between 1 and 1000 (sanity limits)
- Call `setCentsPerMinute(value)`
- Return JSON: `{ centsPerMinute: number, message: 'Settings updated' }`

**Error handling:**
- 401 for unauthorized (requireAdmin handles this)
- 400 for invalid input (not a number, out of range)
- 500 for database errors

Follow pattern from src/app/api/admin/credits/adjust/route.ts for structure.
  </action>
  <verify>
Test with curl (requires valid admin session):
- GET should return current rate (15 by default)
- PUT with valid value should update and return new value
- PUT with invalid value should return 400
  </verify>
  <done>
- GET /api/admin/settings returns { centsPerMinute: 15 } (default)
- PUT /api/admin/settings with { centsPerMinute: 20 } updates the value
- Validation rejects invalid inputs
- Build passes without errors
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx prisma validate` passes
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] SiteSetting table exists in database after migration
- [ ] API endpoints are properly protected with requireAdmin()
</verification>

<success_criteria>
- SiteSetting model defined in Prisma schema
- Migration created and applied
- settings.ts provides getCentsPerMinute/setCentsPerMinute with caching
- Admin API endpoint supports GET and PUT for pricing settings
- All validation and error handling in place
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-admin-price-control/17-01-SUMMARY.md`
</output>
