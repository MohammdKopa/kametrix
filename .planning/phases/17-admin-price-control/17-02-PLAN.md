---
phase: 17-admin-price-control
plan: 02
type: execute
---

<objective>
Add Settings tab to admin dashboard with pricing editor and integrate dynamic rate throughout the application.

Purpose: Provide admin UI for price management and update credit functions to use the database-backed rate.
Output: Admin Settings page with pricing section, credit functions using dynamic rate.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-admin-price-control/17-CONTEXT.md
@.planning/phases/17-admin-price-control/17-01-SUMMARY.md

**Codebase constraints:**
- shadcn/ui components (Button, Card, Input, Label)
- Glassmorphic dark theme with `glass-card` class
- Admin nav uses tabs pattern in admin-nav-tabs.tsx
- Client components use 'use client' directive

**Relevant source files:**
@src/components/admin/admin-nav-tabs.tsx
@src/app/(dashboard)/admin/page.tsx
@src/lib/credits-utils.ts
@src/lib/credits.ts
@src/lib/settings.ts (created in 17-01)

**From CONTEXT.md:**
- Lives in admin Settings page as "Pricing" section
- Single input field with currency formatting
- Quick rate changes, immediate effect
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Settings tab to admin navigation</name>
  <files>src/components/admin/admin-nav-tabs.tsx, src/app/(dashboard)/admin/settings/page.tsx</files>
  <action>
1. Update src/components/admin/admin-nav-tabs.tsx:
   - Import Settings icon from lucide-react
   - Add Settings tab to tabs array: `{ name: 'Settings', href: '/admin/settings', icon: Settings }`

2. Create src/app/(dashboard)/admin/settings/page.tsx:
   - Add 'use client' directive (needs form state)
   - Import Card, CardContent, CardHeader, CardTitle, CardDescription from @/components/ui/card
   - Import Button, Input, Label from @/components/ui
   - Use useEffect to fetch current rate from GET /api/admin/settings
   - State: centsPerMinute (number), loading (boolean), saving (boolean), message (string)

   **UI Structure:**
   ```tsx
   <div>
     <h1 className="text-2xl font-bold text-foreground mb-6">Settings</h1>

     <Card className="glass-card max-w-xl">
       <CardHeader>
         <CardTitle>Pricing</CardTitle>
         <CardDescription>Configure the per-minute call rate</CardDescription>
       </CardHeader>
       <CardContent>
         <form onSubmit={handleSave}>
           <div className="space-y-4">
             <div className="space-y-2">
               <Label htmlFor="rate">Rate per minute (cents)</Label>
               <div className="flex items-center gap-3">
                 <Input
                   id="rate"
                   type="number"
                   min={1}
                   max={1000}
                   value={centsPerMinute}
                   onChange={(e) => setCentsPerMinute(Number(e.target.value))}
                   className="w-32"
                 />
                 <span className="text-muted-foreground">
                   = ${(centsPerMinute / 100).toFixed(2)}/min
                 </span>
               </div>
               <p className="text-sm text-muted-foreground">
                 Changes take effect immediately for all new calls.
               </p>
             </div>
             <Button type="submit" disabled={saving}>
               {saving ? 'Saving...' : 'Save Changes'}
             </Button>
             {message && <p className="text-sm text-green-500">{message}</p>}
           </div>
         </form>
       </CardContent>
     </Card>
   </div>
   ```

3. handleSave function:
   - Prevent default
   - Set saving=true
   - PUT to /api/admin/settings with { centsPerMinute }
   - On success: show "Settings saved" message, clear after 3s
   - On error: show error message
   - Set saving=false
  </action>
  <verify>
- Admin nav shows 4 tabs: Users, Agents, Phone Numbers, Settings
- /admin/settings page renders without errors
- Form shows current rate and allows input
  </verify>
  <done>
- Settings tab appears in admin navigation
- Admin settings page renders with pricing card
- Form displays current rate with dollar conversion
- Save button submits to API
  </done>
</task>

<task type="auto">
  <name>Task 2: Update credit functions to use dynamic rate</name>
  <files>src/lib/credits-utils.ts, src/lib/credits.ts, src/app/api/webhooks/vapi/route.ts, src/app/(dashboard)/dashboard/credits/page.tsx</files>
  <action>
The key insight: `CENTS_PER_MINUTE` is used in both server and client contexts. We need to:
- Keep client-safe functions that accept rate as parameter
- Provide server-side wrappers that fetch the rate

1. Update src/lib/credits-utils.ts:
   - Keep `CENTS_PER_MINUTE = 15` as `DEFAULT_CENTS_PER_MINUTE` (fallback for client)
   - Modify `calculateCallCost(durationSeconds, centsPerMinute = DEFAULT_CENTS_PER_MINUTE)` to accept optional rate
   - Modify `formatBalance(cents, centsPerMinute = DEFAULT_CENTS_PER_MINUTE)` to accept optional rate
   - Modify `getLowBalanceMessage(balanceCents, centsPerMinute = DEFAULT_CENTS_PER_MINUTE)` to accept optional rate
   - Export `DEFAULT_CENTS_PER_MINUTE` for client-side display contexts

2. Update src/lib/credits.ts:
   - Import `getCentsPerMinute` from `@/lib/settings`
   - Create `calculateCallCostWithRate(durationSeconds)` that fetches rate then calculates
   - Create `formatBalanceWithRate(cents)` that fetches rate then formats
   - Export these new functions for server-side use

3. Update src/app/api/webhooks/vapi/route.ts:
   - Import `getCentsPerMinute` from `@/lib/settings`
   - In end-of-call handler, fetch rate with `const centsPerMinute = await getCentsPerMinute()`
   - Pass rate to `calculateCallCost(durationSeconds, centsPerMinute)`

4. Update src/app/(dashboard)/dashboard/credits/page.tsx:
   - This is a server component - can use getCentsPerMinute
   - Fetch rate at top: `const centsPerMinute = await getCentsPerMinute()`
   - Update the pricing display: `Credits are charged at $${(centsPerMinute/100).toFixed(2)} per minute`
   - Pass rate to any formatBalance calls

Note: The dashboard stats card (balance display) uses formatBalance which now accepts optional rate.
For client components showing balance, they can continue using the default rate for display
(the actual billing uses the server-side rate). OR pass the rate as a prop.
  </action>
  <verify>
- `npm run build` succeeds
- `npm run lint` passes
- Functions still work with default rate when parameter not provided
  </verify>
  <done>
- calculateCallCost accepts optional centsPerMinute parameter
- formatBalance accepts optional centsPerMinute parameter
- Vapi webhook uses dynamic rate from database
- Credits page shows dynamic rate from database
- All TypeScript errors resolved
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Admin Settings page with pricing editor and dynamic rate integration</what-built>
  <how-to-verify>
1. Run: npm run dev
2. Login as admin user
3. Navigate to /admin/settings via the new Settings tab
4. Verify: Settings page shows "Pricing" card with current rate (15 cents = $0.15/min)
5. Change the rate to 20 cents
6. Click "Save Changes"
7. Verify: Success message appears
8. Refresh the page - rate should still show 20
9. Navigate to /dashboard/credits
10. Verify: Pricing info shows "$0.20 per minute" (the new rate)
11. Reset rate back to 15 cents in admin settings
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] Admin Settings tab visible and functional
- [ ] Pricing card displays current rate with live dollar conversion
- [ ] Save updates the database and shows confirmation
- [ ] Credit functions use dynamic rate from database
- [ ] Credits page displays the dynamic rate
</verification>

<success_criteria>
- Settings tab added to admin navigation
- Admin settings page with pricing section
- Single input for cents per minute with dollar display
- Save button updates database immediately
- Vapi webhook uses database rate for call billing
- Credits page displays current rate from database
- Human verification confirms end-to-end flow works
- Phase 17 complete
</success_criteria>

<output>
After completion, create `.planning/phases/17-admin-price-control/17-02-SUMMARY.md`
</output>
