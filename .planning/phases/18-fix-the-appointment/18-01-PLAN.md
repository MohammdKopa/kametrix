---
phase: 18-fix-the-appointment
plan: 01
type: execute
---

<objective>
Fix appointment booking date/time validation so the AI correctly interprets dates like "tomorrow", "October 6", or "January 15" based on the current date context.

Purpose: Ensure appointments are booked with correct dates - no more 2023 hallucinations or cascading year corrections that result in wrong dates.
Output: Updated date validation logic and enhanced AI prompts that reliably produce correct appointment dates.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-fix-the-appointment/18-CONTEXT.md

**Problem Summary:**
The AI generates dates with wrong years (2023 instead of 2025), then the date correction logic cascades through fixes:
1. `2023-10-06` → Year corrected to `2025-10-06`
2. `2025-10-06` → Month passed check moves to `2026-10-06`

But if caller says "October 6" in December 2025, they mean October 6, 2026 (next October).
If caller says "January 15" in December 2025, they mean January 15, 2026 (next month).

**Files to modify:**
@src/lib/google/calendar.ts - validateAndCorrectDate() function
@src/app/api/webhooks/vapi/route.ts - handleAssistantRequest() date header and tool descriptions

**Current Implementation:**
- Date header is added dynamically at call time (good)
- Tool descriptions mention AKTUELLES DATUM (good)
- But AI still hallucinates wrong years
- Date correction logic applies year fix then month check (causes cascading issues)

**Desired Behavior:**
- "Tomorrow" → December 30, 2025 (today + 1)
- "October 6" (in December) → October 6, 2026 (next occurrence)
- "January 15" (in December) → January 15, 2026 (coming up)
- Never produce past dates for future appointment requests
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix date validation logic in calendar.ts</name>
  <files>src/lib/google/calendar.ts</files>
  <action>
Rewrite the `validateAndCorrectDate()` function with smarter year inference:

1. Parse the incoming date string (YYYY-MM-DD format)

2. Get current date parts (year, month, day)

3. Determine the correct year using this logic:
   - If the incoming year is clearly wrong (e.g., 2023, 2024 when we're in 2025), ignore it entirely
   - Use the month/day to determine year:
     - If month/day is in the future THIS year → use current year
     - If month/day has already passed THIS year → use next year

4. Handle edge cases:
   - If incoming year matches current or next year AND date is in future → trust it
   - If incoming year is future but > 1 year away → log warning but allow (user may want far future booking)

5. Log the correction with clear reasoning for debugging

Key insight: Treat ANY wrong year (2023, 2024) as "AI hallucinated the year" and infer from month/day context instead of doing sequential corrections that cascade.

Example behavior:
- Input: 2023-10-06, Today: 2025-12-29 → Output: 2026-10-06 (October already passed this year)
- Input: 2023-01-15, Today: 2025-12-29 → Output: 2026-01-15 (January coming next month)
- Input: 2025-12-30, Today: 2025-12-29 → Output: 2025-12-30 (tomorrow, keep as-is)
  </action>
  <verify>
Manual test cases:
```typescript
// Test in Node REPL or add console.log temporarily
validateAndCorrectDate('2023-10-06') // Should return '2026-10-06' (Oct passed)
validateAndCorrectDate('2023-01-15') // Should return '2026-01-15' (Jan coming)
validateAndCorrectDate('2025-12-30') // Should return '2025-12-30' (tomorrow)
validateAndCorrectDate('2025-12-28') // Should return '2026-12-28' (yesterday → next year)
```
  </verify>
  <done>
- validateAndCorrectDate() uses single-pass inference logic
- No cascading year corrections
- Correctly handles past-year hallucinations
- Correctly infers next occurrence of month/day
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance AI date instructions in webhook handler</name>
  <files>src/app/api/webhooks/vapi/route.ts</files>
  <action>
Strengthen the date handling instructions in `handleAssistantRequest()`:

1. Update the `dateHeader` to be more explicit and instructive:
```typescript
const dateHeader = `[AKTUELLES DATUM: ${currentDateStr}]

KRITISCHE DATUMSREGELN:
- Heute ist ${today.getDate()}.${today.getMonth() + 1}.${year}
- Bei "morgen" → ${tomorrowStr} verwenden
- Bei Monatsnamen ohne Jahr:
  * Wenn Monat noch kommt dieses Jahr → ${year} verwenden
  * Wenn Monat schon vorbei ist → ${year + 1} verwenden
- NIEMALS Jahre wie 2023 oder 2024 verwenden
- Alle Termine im Format JJJJ-MM-TT

`;
```

2. Update tool descriptions to be more explicit about date format:
   - For `check_availability`: Include example with CURRENT year
   - For `book_appointment`: Include example with CURRENT year
   - Both should say "z.B. ${currentDateStr}" instead of static "2025-01-15"

3. Add a helper to calculate tomorrow's date string for the prompt

This makes the AI less likely to hallucinate wrong years because:
- It sees concrete examples with the current year
- It has explicit rules for month inference
- The instructions are in German (matching the conversation language)
  </action>
  <verify>
1. Check that handleAssistantRequest builds the correct dateHeader with dynamic values
2. Check that tool descriptions include dynamic year examples
3. Start dev server and verify webhook responds with updated assistant config:
```bash
curl -X POST http://localhost:3000/api/webhooks/vapi \
  -H "Content-Type: application/json" \
  -d '{"message":{"type":"assistant-request","call":{"assistantId":"test"}}}'
```
  </verify>
  <done>
- dateHeader includes explicit date rules in German
- Tool descriptions include current-year examples
- Tomorrow's date is calculated and included in prompt
- AI has clear, unambiguous instructions for date handling
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] validateAndCorrectDate handles all test cases correctly
- [ ] dateHeader includes dynamic current date info
- [ ] Tool descriptions use current year in examples
- [ ] No TypeScript errors in modified files
</verification>

<success_criteria>
- Date validation logic correctly infers year from month/day context
- No cascading year corrections (single-pass inference)
- AI receives explicit, unambiguous date instructions
- Dates like "October 6" in December correctly resolve to next year
- Dates like "January 15" in December correctly resolve to next month
- Phase 18 complete
</success_criteria>

<output>
After completion, create `.planning/phases/18-fix-the-appointment/18-01-SUMMARY.md`
</output>
