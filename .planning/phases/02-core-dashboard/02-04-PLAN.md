---
phase: 02-core-dashboard
plan: 04
type: execute
---

<objective>
Build admin dashboard with visibility into all users, agents, and phone numbers.

Purpose: Admins need to see and manage all platform data - users, their agents, calls, credits, and phone numbers. Uses same UI patterns as user dashboard but with broader data access.
Output: Admin section with user list, ability to view any user's data, phone number management, and admin API routes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-dashboard/02-CONTEXT.md
@.planning/phases/02-core-dashboard/02-01-SUMMARY.md
@.planning/phases/02-core-dashboard/02-02-SUMMARY.md
@.planning/phases/02-core-dashboard/02-03-SUMMARY.md

**Prior decisions:**
- Admin uses same interface with broader visibility (02-CONTEXT.md)
- No separate admin-specific UI - just data access
- requireAdmin helper exists in auth-guard.ts

**Database models for admin:**
- User: all users with roles
- Agent: all agents across users
- PhoneNumber: all phone numbers with status

**Admin capabilities needed:**
- View all users
- View any user's agents, calls, credits
- Manage phone numbers (view, assign, release)
- Adjust user credits (admin adjustment)

@src/lib/auth-guard.ts
@src/middleware.ts (protects /admin/* routes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin layout and user list</name>
  <files>src/app/(dashboard)/admin/layout.tsx, src/app/(dashboard)/admin/page.tsx, src/components/admin/user-list.tsx, src/components/admin/user-row.tsx, src/app/api/admin/users/route.ts</files>
  <action>
    Create admin section:

    1. Create src/app/(dashboard)/admin/layout.tsx:
       - Verify admin role (redirect non-admins)
       - Similar structure to dashboard layout
       - Tab navigation: Users, Agents, Phone Numbers, (optionally: All Calls)
       - Reuse nav-tabs pattern but with admin routes

    2. Create src/app/api/admin/users/route.ts:
       - GET: List all users (admin only)
       - Use requireAdmin
       - Include counts: agentCount, callCount (via _count)
       - Support search: ?search=email
       - Paginate: ?page=1&limit=20
       - Return: users array, total, hasMore

    3. Create src/components/admin/user-row.tsx:
       - Row showing user info
       - Display: email, name, role badge, credit balance, agent count, created date
       - "View" button to see user details
       - Role badge: USER (gray), ADMIN (purple)

    4. Create src/components/admin/user-list.tsx:
       - Table of users
       - Search input at top
       - Pagination

    5. Create src/app/(dashboard)/admin/page.tsx:
       - Admin overview/users page
       - Shows user list
       - Stats at top: Total Users, Total Agents, Total Calls (optional)
  </action>
  <verify>npm run build succeeds, /admin shows user list for admin users</verify>
  <done>Admin page renders with user list, non-admins redirected</done>
</task>

<task type="auto">
  <name>Task 2: Create admin API routes for data access</name>
  <files>src/app/api/admin/users/[id]/route.ts, src/app/api/admin/agents/route.ts, src/app/api/admin/phone-numbers/route.ts, src/app/api/admin/phone-numbers/[id]/route.ts, src/app/api/admin/credits/adjust/route.ts</files>
  <action>
    Create admin-level API routes:

    1. Create src/app/api/admin/users/[id]/route.ts:
       - GET: Get specific user with their agents, recent calls, credit balance
       - Include relations: agents (with phone), recent 10 calls
       - Admin only

    2. Create src/app/api/admin/agents/route.ts:
       - GET: List all agents across all users
       - Include user email and phone number
       - Support filters: ?userId=xxx, ?isActive=true
       - Paginate

    3. Create src/app/api/admin/phone-numbers/route.ts:
       - GET: List all phone numbers
       - Include agent relation if assigned
       - Support filters: ?status=AVAILABLE
       - POST: Add new phone number (number, twilioSid optional, vapiPhoneId optional)

    4. Create src/app/api/admin/phone-numbers/[id]/route.ts:
       - PATCH: Update phone number (assign to agent, change status)
       - DELETE: Remove phone number (only if AVAILABLE)

    5. Create src/app/api/admin/credits/adjust/route.ts:
       - POST: Adjust user credits (admin adjustment)
       - Body: { userId, amount, description }
       - Creates CreditTransaction with type ADMIN_ADJUSTMENT
       - Updates user.creditBalance
       - Returns updated balance

    All routes use requireAdmin. Return proper error codes (403 for non-admin, 404 for not found).
  </action>
  <verify>npm run build succeeds, admin API routes return correct data</verify>
  <done>All admin API routes functional with proper authorization</done>
</task>

<task type="auto">
  <name>Task 3: Create admin UI for agents and phone numbers</name>
  <files>src/app/(dashboard)/admin/agents/page.tsx, src/app/(dashboard)/admin/phone-numbers/page.tsx, src/components/admin/phone-number-list.tsx, src/components/admin/agent-list-admin.tsx, src/app/(dashboard)/admin/users/[id]/page.tsx</files>
  <action>
    Complete admin UI:

    1. Create src/app/(dashboard)/admin/agents/page.tsx:
       - List all agents across platform
       - Show: agent name, user email, phone number, status, created
       - Filter by user (dropdown) or status
       - Links to user detail for management

    2. Create src/components/admin/agent-list-admin.tsx:
       - Admin version of agent list
       - Includes user email column
       - View/manage links

    3. Create src/app/(dashboard)/admin/phone-numbers/page.tsx:
       - List all phone numbers
       - Show: number, status badge, assigned agent (if any), user (if any)
       - "Add Phone Number" button (simple form/modal)
       - Assign/release functionality

    4. Create src/components/admin/phone-number-list.tsx:
       - Table of phone numbers
       - Status badges: AVAILABLE (green), ASSIGNED (blue), RELEASED (gray)
       - Actions: Assign (if available), Release (if assigned)

    5. Create src/app/(dashboard)/admin/users/[id]/page.tsx:
       - User detail page
       - Show user info, credit balance
       - Credit adjustment form (amount, description, submit)
       - List of user's agents
       - Recent calls list
  </action>
  <verify>npm run build succeeds, admin can view agents, phone numbers, and user details</verify>
  <done>Admin UI complete with agents list, phone numbers management, and user detail view</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete admin dashboard with user, agent, and phone number management</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Log in as an admin user (you may need to manually set role=ADMIN in database)
    3. Visit: http://localhost:3000/admin
    4. Check user list:
       - Users displayed with email, credits, agent count
       - Search works
       - Click user to see details
    5. Check agents tab:
       - All agents across users visible
       - User email shown for each
    6. Check phone numbers tab:
       - Phone numbers listed with status
       - Can add new phone number
    7. Check user detail page:
       - Can adjust credits
       - User's agents and calls visible
    8. Verify non-admin access:
       - Log in as regular user
       - Visit /admin - should redirect or show error
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] Admin routes protected (non-admins get 403)
- [ ] User list shows all users with counts
- [ ] Can view individual user details
- [ ] Agent list shows all agents with user info
- [ ] Phone number management works (add, assign, release)
- [ ] Credit adjustment creates transaction and updates balance
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Admin can view and manage all platform data
- Non-admins cannot access admin routes
- Phase 2 complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-dashboard/02-04-SUMMARY.md`:

# Phase 02-04: Admin Dashboard Summary

**[Substantive one-liner]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [File list with descriptions]

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Phase 2 complete. Ready for Phase 3: Vapi Integration
</output>
