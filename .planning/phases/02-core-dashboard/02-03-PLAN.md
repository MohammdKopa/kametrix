---
phase: 02-core-dashboard
plan: 03
type: execute
---

<objective>
Build call history and credit balance views for users.

Purpose: Users need to see their call history and credit balance/transactions. This provides visibility into usage and remaining credits.
Output: Call history list page with basic filtering, credit balance display with transaction history.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-dashboard/02-CONTEXT.md
@.planning/phases/02-core-dashboard/02-01-SUMMARY.md
@.planning/phases/02-core-dashboard/02-02-SUMMARY.md

**Prior decisions:**
- Tab navigation: Dashboard, Agents, Calls, Settings
- Clean/minimal aesthetic
- No detailed analytics - just simple lists

**Database schema:**

Call model:
- id, agentId, userId, vapiCallId, phoneNumber, status (enum)
- startedAt, endedAt, durationSeconds, creditsUsed, summary, transcript

CreditTransaction model:
- id, userId, type (PURCHASE, CALL_USAGE, ADMIN_ADJUSTMENT, GRACE_USAGE)
- amount (+/-), balanceAfter, description, callId, stripePaymentId

User model:
- creditBalance, graceCreditsUsed

**Boundaries:**
- Simple call history list (no graphs/charts)
- Credit balance from User.creditBalance
- Transaction history list

@src/lib/prisma.ts
@src/lib/auth-guard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create call history page</name>
  <files>src/app/(dashboard)/dashboard/calls/page.tsx, src/components/dashboard/call-list.tsx, src/components/dashboard/call-row.tsx, src/app/api/calls/route.ts</files>
  <action>
    Create the calls list view:

    1. Create src/app/api/calls/route.ts:
       - GET: List calls for authenticated user
       - Include agent relation (for agent name)
       - Support query params: ?status=COMPLETED, ?agentId=xxx
       - Paginate: ?page=1&limit=20 (default 20 per page)
       - Sort by startedAt desc (newest first)
       - Return: calls array, total count, hasMore

    2. Create src/components/dashboard/call-row.tsx:
       - Table row or card showing call info
       - Display: date/time, agent name, phone number, duration, status badge, credits used
       - Status badges: color-coded (green=COMPLETED, red=FAILED, yellow=IN_PROGRESS, etc.)
       - Click to expand and show summary/transcript (optional, can be simple)

    3. Create src/components/dashboard/call-list.tsx:
       - Table or list component for calls
       - Headers: Date, Agent, Phone, Duration, Status, Credits
       - Empty state: "No calls yet. Calls will appear here once your agents start receiving them."
       - Simple pagination (Previous/Next buttons)

    4. Create src/app/(dashboard)/dashboard/calls/page.tsx:
       - Server component wrapper
       - Optional: simple filter dropdown for status
       - Uses call-list component

    Keep it simple - a clean table/list view. No complex filtering or date range pickers.
  </action>
  <verify>npm run build succeeds, /dashboard/calls shows call list (empty state if none)</verify>
  <done>Call history page renders with table showing call details and status</done>
</task>

<task type="auto">
  <name>Task 2: Create credit balance and transaction history</name>
  <files>src/app/(dashboard)/dashboard/settings/page.tsx, src/components/dashboard/credit-balance.tsx, src/components/dashboard/transaction-list.tsx, src/app/api/credits/route.ts, src/app/api/credits/transactions/route.ts</files>
  <action>
    Create credit views (placed in Settings for now):

    1. Create src/app/api/credits/route.ts:
       - GET: Return current user's credit info
       - Returns: { balance: number, graceCreditsUsed: number }

    2. Create src/app/api/credits/transactions/route.ts:
       - GET: List credit transactions for user
       - Paginate: ?page=1&limit=20
       - Sort by createdAt desc
       - Return: transactions array, total, hasMore

    3. Create src/components/dashboard/credit-balance.tsx:
       - Display current credit balance prominently
       - Show grace credits used if > 0 (warning style)
       - "Buy Credits" button (links to future payment page, for now just placeholder or disabled)

    4. Create src/components/dashboard/transaction-list.tsx:
       - Table/list of transactions
       - Display: date, type badge, amount (+/-), description, balance after
       - Type badges: PURCHASE (green), CALL_USAGE (gray), ADMIN_ADJUSTMENT (blue), GRACE_USAGE (yellow)
       - Amount: positive green, negative red
       - Empty state: "No transactions yet."

    5. Create src/app/(dashboard)/dashboard/settings/page.tsx:
       - Settings page with sections
       - Section 1: Account Info (email, name - display only for now)
       - Section 2: Credits (balance card + transaction list)
       - Section 3: Placeholder for future settings (integrations, etc.)

    Format credits nicely - they're stored in cents, display as dollars ($X.XX) or as "X credits" depending on your preference. Be consistent.
  </action>
  <verify>npm run build succeeds, /dashboard/settings shows credit balance and transactions</verify>
  <done>Settings page shows credit balance, transaction history, and account info</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] GET /api/calls returns user's calls with pagination
- [ ] GET /api/credits returns user's balance
- [ ] GET /api/credits/transactions returns transaction history
- [ ] Calls page shows list with status badges
- [ ] Settings page shows credit balance and transactions
- [ ] Empty states display correctly when no data
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Call history page functional with filtering
- Credit balance and transactions display correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-dashboard/02-03-SUMMARY.md`:

# Phase 02-03: Calls & Credits Views Summary

**[Substantive one-liner]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [File list with descriptions]

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 02-04-PLAN.md (Admin Dashboard)
</output>
