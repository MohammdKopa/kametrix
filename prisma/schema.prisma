// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum Role {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum CallStatus {
  RINGING
  IN_PROGRESS
  COMPLETED
  FAILED
  NO_ANSWER
  ESCALATED
  TRANSFERRED
}

enum EscalationReason {
  USER_REQUEST           // User explicitly asked for human agent
  LOW_CONFIDENCE         // AI detected low confidence in responses
  REPEATED_CLARIFICATION // Multiple clarification attempts
  UNRECOGNIZED_INTENT    // Could not understand user intent
  COMPLEX_ISSUE          // Issue too complex for AI
  SENTIMENT_NEGATIVE     // Detected frustrated/angry customer
  MAX_DURATION           // Call exceeded maximum AI duration
  EXPLICIT_TRIGGER       // Specific keyword/phrase triggered escalation
}

enum EscalationStatus {
  PENDING        // Escalation initiated, waiting for transfer
  IN_QUEUE       // Call in operator queue
  CONNECTED      // Successfully connected to human
  FAILED         // Transfer failed
  NO_OPERATORS   // No operators available
  TIMEOUT        // Transfer timed out
  CANCELLED      // User cancelled before transfer
}

enum TransactionType {
  PURCHASE
  CALL_USAGE
  ADMIN_ADJUSTMENT
  GRACE_USAGE
}

enum PhoneStatus {
  AVAILABLE
  ASSIGNED
  RELEASED
}

// Models
model User {
  id                  String              @id @default(cuid())
  email               String              @unique @db.VarChar(255)
  passwordHash        String
  name                String?
  username            String?             @unique @db.VarChar(50) // optional unique username
  role                Role                @default(USER)
  status              UserStatus          @default(ACTIVE) // account status for activation/deactivation
  creditBalance       Int                 @default(0) // current credit balance in cents
  graceCreditsUsed    Int                 @default(0) // credits used during grace period

  // Stripe integration
  stripeCustomerId    String?             @unique // Stripe customer ID

  // Google integration
  googleRefreshToken   String?             // encrypted refresh token for Google OAuth
  googleAccessToken    String?             // encrypted access token for Google OAuth (cached)
  googleTokenExpiresAt DateTime?           // when the access token expires
  googleSheetId        String?             // auto-created logging spreadsheet ID
  googleConnectedAt    DateTime?           // when Google was connected
  appointmentDuration  Int                 @default(30) // appointment duration in minutes

  // Calendar settings
  calendarSyncEnabled  Boolean             @default(false)
  defaultTimezone      String?
  lastCalendarSync     DateTime?

  // Account management
  lastPasswordReset    DateTime?           // last password reset timestamp
  deactivatedAt        DateTime?           // when account was deactivated
  deactivatedBy        String?             // admin who deactivated

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // Relations
  agents              Agent[]
  calls               Call[]
  creditTransactions  CreditTransaction[]
  sessions            Session[]
  calendarEvents      CalendarEvent[]
  calendarSyncLogs    CalendarSyncLog[]
  calendarSyncQueues  CalendarSyncQueue[]
  adminAuditLogs      AdminAuditLog[]     @relation("AdminAuditLogs") // audit logs performed by this admin
  userAuditLogs       AdminAuditLog[]     @relation("UserAuditLogs")  // audit logs targeting this user
}

model Agent {
  id                  String      @id @default(cuid())
  userId              String
  name                String
  vapiAssistantId     String?     @unique // Vapi's assistant ID (null until created in Vapi)
  greeting            String
  systemPrompt        String      @db.Text
  voiceId             String
  businessName        String
  businessDescription String?     @db.Text
  isActive            Boolean     @default(true)

  // Calendar integration
  primaryCalendarId   String?     // Google calendar ID for scheduling
  checkCalendarIds    String[]    @default([]) // Calendar IDs to check for conflicts
  defaultTimezone     String?     // Timezone for appointments

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  // Relations
  user                User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  calls               Call[]
  phoneNumber         PhoneNumber?
  calendarEvents      CalendarEvent[]
  escalationConfig    EscalationConfig?

  // Performance indexes
  @@index([userId])
  @@index([isActive])
  @@index([userId, isActive])
  @@index([createdAt(sort: Desc)])
}

model Session {
  id                 String   @id @default(cuid())
  userId             String
  token              String   @unique
  expiresAt          DateTime
  browserFingerprint String?  // Browser fingerprint for session validation
  csrfToken          String?  // CSRF token for form validation
  createdAt          DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([userId])
  @@index([expiresAt])
}

model Call {
  id              String      @id @default(cuid())
  agentId         String
  userId          String      // denormalized for easier queries
  vapiCallId      String?     @unique // Vapi's call ID
  phoneNumber     String
  status          CallStatus
  startedAt       DateTime
  endedAt         DateTime?
  durationSeconds Int?
  creditsUsed     Int         @default(0)
  summary         String?     @db.Text // AI-generated call summary
  transcript      String?     @db.Text // full transcript

  // AI Analysis fields
  sentiment        String?     // "positive", "negative", "neutral"
  sentimentScore   Float?      // -1.0 to 1.0
  keyTopics        String[]    @default([])
  customerIntents  String[]    @default([])
  actionItems      String[]    @default([])
  followUpRequired Boolean     @default(false)
  analysisJson     Json?       // Full analysis data

  // Escalation fields
  escalatedAt         DateTime?         // When escalation was triggered
  escalationReason    EscalationReason? // Why the call was escalated
  escalationStatus    EscalationStatus? // Current status of escalation
  escalatedToNumber   String?           // Phone number/queue transferred to
  escalationNotes     String?           @db.Text // Context passed to human operator
  transferAttempts    Int               @default(0) // Number of transfer attempts
  humanConnectedAt    DateTime?         // When human operator connected
  escalationMetadata  Json?             // Additional escalation data

  createdAt       DateTime    @default(now())

  // Relations
  agent           Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  escalationLog   EscalationLog?

  // Performance indexes
  @@index([userId])
  @@index([agentId])
  @@index([status])
  @@index([startedAt(sort: Desc)])
  @@index([userId, startedAt(sort: Desc)])
  @@index([userId, status])
}

model CreditPack {
  id            String   @id @default(cuid())
  name          String
  credits       Int      // amount of credits
  priceInCents  Int      // price in cents
  stripePriceId String?  @unique // Stripe price ID
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model CreditTransaction {
  id              String          @id @default(cuid())
  userId          String
  type            TransactionType
  amount          Int             // positive for purchases, negative for usage
  balanceAfter    Int             // balance after this transaction
  description     String?
  callId          String?         // if deducted for a call
  stripePaymentId String?         // if from Stripe payment
  createdAt       DateTime        @default(now())

  // Relations
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([type])
}

model PhoneNumber {
  id          String      @id @default(cuid())
  number      String      @unique // E.164 format
  agentId     String?     @unique // one phone per agent
  twilioSid   String?     @unique // Twilio phone number SID
  vapiPhoneId String?     @unique // Vapi phone number ID
  status      PhoneStatus
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  agent       Agent?      @relation(fields: [agentId], references: [id], onDelete: SetNull)
}

model SiteSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

// ============================================
// Calendar Models
// ============================================

enum CalendarSyncStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

model CalendarEvent {
  id              String    @id @default(cuid())
  userId          String
  googleEventId   String    // Google Calendar event ID
  title           String
  description     String?   @db.Text
  startTime       DateTime
  endTime         DateTime
  location        String?
  attendees       Json?     // Array of attendee emails
  createdByAgent  String?   // Agent ID if created by an agent
  metadata        Json?     // Additional event data
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent           Agent?    @relation(fields: [createdByAgent], references: [id], onDelete: SetNull)

  @@unique([userId, googleEventId])
  @@index([startTime])
  @@index([userId, startTime])
}

model CalendarSyncLog {
  id            String   @id @default(cuid())
  userId        String
  eventsCreated Int      @default(0)
  eventsUpdated Int      @default(0)
  eventsDeleted Int      @default(0)
  errorMessage  String?
  createdAt     DateTime @default(now())

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model CalendarSyncQueue {
  id          String             @id @default(cuid())
  userId      String
  status      CalendarSyncStatus @default(PENDING)
  priority    Int                @default(0)
  attempts    Int                @default(0)
  lastError   String?
  scheduledAt DateTime           @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime           @default(now())

  // Relations
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([userId, status])
}

// ============================================
// Monitoring & Analytics Models
// ============================================

enum MetricType {
  COUNTER
  GAUGE
  HISTOGRAM
  TIMING
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
}

enum ServiceStatus {
  HEALTHY
  DEGRADED
  UNHEALTHY
  UNKNOWN
}

// Persistent system metrics for historical analysis
model SystemMetric {
  id          String     @id @default(cuid())
  name        String
  type        MetricType
  value       Float
  tags        Json?      // {"route": "/api/calls", "method": "GET"}
  recordedAt  DateTime   @default(now())

  @@index([name, recordedAt(sort: Desc)])
  @@index([recordedAt(sort: Desc)])
}

// Uptime monitoring records
model UptimeRecord {
  id            String        @id @default(cuid())
  serviceName   String        // "api", "database", "vapi", "google", "stripe"
  status        ServiceStatus
  responseTimeMs Int?
  errorMessage  String?
  checkedAt     DateTime      @default(now())

  @@index([serviceName, checkedAt(sort: Desc)])
  @@index([checkedAt(sort: Desc)])
}

// User analytics and engagement tracking
model UserAnalytics {
  id                String   @id @default(cuid())
  userId            String   @unique
  totalSessions     Int      @default(0)
  totalCallsPlaced  Int      @default(0)
  totalCallDuration Int      @default(0)  // in seconds
  totalCreditsUsed  Int      @default(0)
  lastActiveAt      DateTime?
  firstSeenAt       DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([lastActiveAt(sort: Desc)])
  @@index([userId])
}

// Event log for user activity tracking
model EventLog {
  id         String   @id @default(cuid())
  userId     String?
  eventType  String   // "login", "logout", "agent_created", "call_made", "credits_purchased"
  eventData  Json?    // Additional event-specific data
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([eventType, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

// Alerts for anomalies and issues
model MonitoringAlert {
  id          String        @id @default(cuid())
  severity    AlertSeverity
  status      AlertStatus   @default(ACTIVE)
  title       String
  message     String        @db.Text
  source      String        // "error_rate", "latency", "memory", "service_down"
  metadata    Json?
  triggeredAt DateTime      @default(now())
  resolvedAt  DateTime?
  resolvedBy  String?       // admin userId who resolved

  @@index([status, severity])
  @@index([triggeredAt(sort: Desc)])
  @@index([source, status])
}

// Aggregated metrics for dashboard (hourly/daily rollups)
model MetricAggregate {
  id         String   @id @default(cuid())
  name       String
  period     String   // "hourly", "daily"
  periodKey  String   // "2024-01-15-14" for hourly, "2024-01-15" for daily
  count      Int      @default(0)
  sum        Float    @default(0)
  min        Float?
  max        Float?
  avg        Float?
  p50        Float?
  p95        Float?
  p99        Float?
  createdAt  DateTime @default(now())

  @@unique([name, period, periodKey])
  @@index([name, periodKey(sort: Desc)])
}

// ============================================
// API Rate Limiting & Quota Management Models
// ============================================

enum QuotaType {
  GOOGLE_CALENDAR
  API_GENERAL
  API_WEBHOOK
}

enum QuotaPeriod {
  MINUTE
  HOUR
  DAY
  MONTH
}

// Per-user API quota configuration and tracking
model ApiQuota {
  id              String      @id @default(cuid())
  userId          String
  quotaType       QuotaType
  period          QuotaPeriod
  maxRequests     Int         // Maximum requests allowed per period
  usedRequests    Int         @default(0) // Current usage count
  periodStartAt   DateTime    @default(now()) // When current period started
  lastRequestAt   DateTime?   // Last API request timestamp
  isBlocked       Boolean     @default(false) // Manual block flag
  blockReason     String?     // Reason for blocking
  blockExpiresAt  DateTime?   // When block expires
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@unique([userId, quotaType, period])
  @@index([userId])
  @@index([quotaType])
  @@index([periodStartAt])
}

// Detailed API usage log for analytics and debugging
model ApiUsageLog {
  id            String    @id @default(cuid())
  userId        String?   // Null for unauthenticated requests
  agentId       String?   // If request is related to an agent
  endpoint      String    // API endpoint path
  method        String    // HTTP method
  quotaType     QuotaType
  statusCode    Int       // HTTP status code returned
  responseTimeMs Int?     // Response time in milliseconds
  ipAddress     String?   // Client IP address
  userAgent     String?   // User agent string
  errorMessage  String?   // Error message if request failed
  metadata      Json?     // Additional request metadata
  createdAt     DateTime  @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([endpoint, createdAt(sort: Desc)])
  @@index([quotaType, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

// Google Calendar API specific quota tracking (aligns with Google's quotas)
model GoogleCalendarQuota {
  id                  String    @id @default(cuid())
  userId              String    @unique

  // Daily quota tracking (Google Calendar API has daily limits)
  dailyRequestsUsed   Int       @default(0)
  dailyRequestsLimit  Int       @default(1000000) // Google's default is 1M/day per project
  dailyResetAt        DateTime  @default(now())

  // Per-user daily limits (for fair resource allocation)
  userDailyLimit      Int       @default(10000) // Per-user limit
  userDailyUsed       Int       @default(0)

  // Rate limiting (queries per 100 seconds)
  queriesPerMinute    Int       @default(60) // Default 60 QPM per user
  minuteWindowUsed    Int       @default(0)
  minuteWindowStart   DateTime  @default(now())

  // Burst protection
  lastRequestAt       DateTime?
  consecutiveErrors   Int       @default(0) // Track API errors
  lastErrorAt         DateTime?

  // Status
  isThrottled         Boolean   @default(false)
  throttleExpiresAt   DateTime?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([dailyResetAt])
  @@index([isThrottled])
}

// Quota alerts for monitoring
model QuotaAlert {
  id            String        @id @default(cuid())
  userId        String?       // Null for system-wide alerts
  quotaType     QuotaType
  alertType     String        // "warning_80", "critical_95", "exceeded"
  message       String
  threshold     Int           // Percentage threshold that triggered alert
  currentUsage  Int           // Usage when alert was triggered
  maxAllowed    Int           // Maximum allowed when alert triggered
  acknowledged  Boolean       @default(false)
  acknowledgedBy String?      // Admin who acknowledged
  acknowledgedAt DateTime?
  createdAt     DateTime      @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([quotaType, acknowledged])
  @@index([createdAt(sort: Desc)])
}

// ============================================
// Call Escalation & Forwarding Models
// ============================================

// Configuration for call escalation per agent
model EscalationConfig {
  id                    String    @id @default(cuid())
  agentId               String    @unique

  // Enable/disable escalation
  enabled               Boolean   @default(true)

  // Primary forwarding destination
  forwardingNumber      String?   // Phone number to forward to
  forwardingQueue       String?   // Queue identifier (e.g., "sales", "support")
  forwardingDepartment  String?   // Department name

  // Fallback options
  fallbackNumber        String?   // Backup number if primary fails
  voicemailEnabled      Boolean   @default(true) // Allow voicemail if no operators
  voicemailGreeting     String?   @db.Text // Custom voicemail message

  // Business hours routing
  businessHoursStart    String?   // e.g., "09:00"
  businessHoursEnd      String?   // e.g., "18:00"
  businessDays          String[]  @default(["Mon", "Tue", "Wed", "Thu", "Fri"])
  afterHoursNumber      String?   // Number for after-hours calls
  afterHoursMessage     String?   @db.Text // Message to play after hours
  timezone              String    @default("Europe/Berlin")

  // Escalation triggers
  maxCallDuration       Int       @default(300) // Max seconds before auto-escalate (0 = disabled)
  maxClarifications     Int       @default(3) // Max clarification attempts
  sentimentThreshold    Float     @default(-0.5) // Sentiment score threshold for escalation

  // Custom trigger phrases (JSON array of strings)
  triggerPhrases        Json      @default("[]") // e.g., ["I want to speak to a human", "representative"]

  // Transfer settings
  maxTransferWaitTime   Int       @default(60) // Max seconds to wait for transfer
  announceTransfer      Boolean   @default(true) // Announce transfer to caller
  transferMessage       String?   @db.Text // Custom message during transfer
  holdMusicUrl          String?   // URL to hold music

  // Context sharing
  shareTranscript       Boolean   @default(true) // Share conversation with human
  shareSummary          Boolean   @default(true) // Share AI-generated summary
  shareCallerInfo       Boolean   @default(true) // Share caller phone number

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  agent                 Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

// Detailed log of all escalation events for analytics
model EscalationLog {
  id                  String            @id @default(cuid())
  callId              String            @unique
  agentId             String
  userId              String

  // Escalation details
  reason              EscalationReason
  status              EscalationStatus
  triggeredAt         DateTime          @default(now())

  // Transfer details
  transferNumber      String?           // Number transferred to
  transferQueue       String?           // Queue name
  transferAttempts    Int               @default(1)
  transferStartedAt   DateTime?         // When transfer was initiated
  transferCompletedAt DateTime?         // When transfer succeeded/failed
  waitTimeSeconds     Int?              // How long caller waited

  // Context captured
  conversationSummary String?           @db.Text // AI summary at escalation time
  lastAiMessage       String?           @db.Text // Last AI message before escalation
  lastUserMessage     String?           @db.Text // User message that triggered escalation
  callerSentiment     String?           // Sentiment at escalation time
  sentimentScore      Float?            // Sentiment score at escalation
  clarificationCount  Int               @default(0) // Number of clarifications attempted
  callDurationAtEscalation Int?         // Call duration in seconds when escalated

  // Outcome tracking
  humanConnectedAt    DateTime?         // When human connected
  humanAgentId        String?           // ID of human who handled the call
  resolutionNotes     String?           @db.Text // Notes from human agent
  wasResolved         Boolean?          // Was the issue resolved?
  customerSatisfied   Boolean?          // Customer satisfaction indicator

  // Failure details
  failureReason       String?           // Why transfer failed
  fallbackUsed        Boolean           @default(false) // Was fallback number used
  voicemailLeft       Boolean           @default(false) // Did caller leave voicemail

  // Additional metadata
  metadata            Json?             // Additional data

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relations
  call                Call              @relation(fields: [callId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([userId])
  @@index([reason])
  @@index([status])
  @@index([triggeredAt(sort: Desc)])
  @@index([userId, triggeredAt(sort: Desc)])
  @@index([agentId, triggeredAt(sort: Desc)])
}

// ============================================
// Admin Audit Log for User Management
// ============================================

enum AdminAction {
  // User Management
  USER_UPDATE           // Updated user details
  USER_ROLE_CHANGE      // Changed user role
  USER_STATUS_CHANGE    // Activated/deactivated/suspended user
  USER_PASSWORD_RESET   // Reset user password
  USER_CREDIT_ADJUST    // Adjusted user credits
  USER_DELETE           // Deleted user account
  BULK_STATUS_CHANGE    // Bulk status change
  BULK_ROLE_CHANGE      // Bulk role change
  BULK_DELETE           // Bulk user deletion

  // Agent Management
  AGENT_CREATE          // Created new agent
  AGENT_UPDATE          // Updated agent configuration
  AGENT_DELETE          // Deleted agent
  AGENT_TOGGLE_STATUS   // Enabled/disabled agent

  // Phone Number Management
  PHONE_ASSIGN          // Assigned phone number to agent
  PHONE_RELEASE         // Released phone number from agent
  PHONE_SYNC            // Synced phone numbers with provider

  // System Configuration
  SETTINGS_UPDATE       // Updated system settings

  // Access & Security
  ADMIN_LOGIN           // Admin logged in
  ADMIN_LOGOUT          // Admin logged out
  ACCESS_DENIED         // Access attempt denied

  // Compliance & Reporting
  AUDIT_EXPORT          // Exported audit logs
  COMPLIANCE_REPORT     // Generated compliance report
}

model AdminAuditLog {
  id              String      @id @default(cuid())
  adminId         String      // Admin who performed the action
  targetUserId    String?     // User affected by the action (null for bulk operations)
  action          AdminAction
  description     String      @db.Text // Human-readable description
  previousValue   Json?       // Previous state before change
  newValue        Json?       // New state after change
  ipAddress       String?     // Admin's IP address
  userAgent       String?     // Admin's browser/user agent
  metadata        Json?       // Additional context data

  createdAt       DateTime    @default(now())

  // Relations
  admin           User        @relation("AdminAuditLogs", fields: [adminId], references: [id], onDelete: Cascade)
  targetUser      User?       @relation("UserAuditLogs", fields: [targetUserId], references: [id], onDelete: SetNull)

  @@index([adminId])
  @@index([targetUserId])
  @@index([action])
  @@index([createdAt(sort: Desc)])
  @@index([adminId, createdAt(sort: Desc)])
  @@index([targetUserId, createdAt(sort: Desc)])
}
